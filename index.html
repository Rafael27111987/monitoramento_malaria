<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento de Malária - Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* Ajuste crucial: removemos a altura fixa (80vh) e confiamos no flex-grow */
        .chat-container {
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }
        .user-message {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            border-top-right-radius: 1rem;
            border-bottom-left-radius: 1rem;
            border-top-left-radius: 1rem;
            margin-left: auto; /* Alinha à direita */
        }
        .gemini-message {
            background-color: #eef2ff; /* Indigo-50 */
            color: #1e293b; /* Slate-800 */
            border-top-left-radius: 1rem;
            border-bottom-right-radius: 1rem;
            border-top-right-radius: 1rem;
            margin-right: auto; /* Alinha à esquerda */
        }
        .chat-container > div {
            max-width: 80%;
        }
        /* Estilos do Scrollbar Customizado para o formulário */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c3c3c3;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Tela de Login -->
    <div id="login-screen" class="flex flex-col items-center justify-center p-8 bg-white shadow-2xl rounded-2xl w-full max-w-md transition-all duration-500">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-indigo-600 mb-4" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 12h-2v-4h-2V7h4v5h2z" />
        </svg>
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">Monitoramento da Malária em Porto Velho</h1>
        <p class="text-gray-600 mb-6 text-center">Entre para iniciar seu check-in diário e receber monitoramento personalizado.</p>
        <button id="google-signin-btn" class="flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 shadow-md focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 48 48" fill="currentColor">
                <path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.692-5.743 7.917-10.303 7.917-6.903 0-12.498-5.592-12.498-12.496s5.595-12.496 12.498-12.496c3.243 0 6.208 1.157 8.524 3.037l-4.243 3.491c-1.353-.98-3.044-1.579-4.281-1.579-4.881 0-8.86 3.988-8.86 8.873s3.979 8.873 8.86 8.873c5.32 0 8.544-4.438 8.95-6.736h-8.95v-6.004z"/>
                <path fill="#FF3D00" d="M6.306 14.693l-4.405 3.486c-.991 1.932-1.501 3.992-1.501 6.321s.51 4.389 1.501 6.321l4.405 3.486c.942-2.228 1.487-4.498 1.487-7.238s-.545-5.01-1.487-7.238z"/>
                <path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.4-5.195l-5.694-4.493c-2.091 1.585-4.707 2.488-7.706 2.488-5.32 0-9.858-3.342-11.666-8.23l-5.378 4.227c2.618 6.275 9.421 10.708 16.944 10.708z"/>
                <path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.692-5.743 7.917-10.303 7.917-6.903 0-12.498-5.592-12.498-12.496s5.595-12.496 12.498-12.496c3.243 0 6.208 1.157 8.524 3.037l-4.243 3.491c-1.353-.98-3.044-1.579-4.281-1.579-4.881 0-8.86 3.988-8.86 8.873s3.979 8.873 8.86 8.873c5.32 0 8.544-4.438 8.95-6.736h-8.95v-6.004z"/>
            </svg>
            Entrar com Google
        </button>
    </div>

    <!-- Tela do Chat - Altura ajustada para 95% da tela e responsividade de bordas -->
    <div id="chat-screen" class="hidden flex flex-col w-full max-w-2xl bg-white shadow-2xl rounded-none md:rounded-2xl h-[95vh] transition-opacity duration-500 opacity-0">
        <!-- Cabeçalho do Chat - CENTRALIZADO -->
        <header class="p-4 bg-indigo-600 text-white rounded-t-none md:rounded-t-2xl shadow-md flex flex-col justify-center items-center">
            <!-- Título Centralizado -->
            <h2 class="text-xl font-bold">Monitoramento de Malária PVH</h2>
            <!-- Nome do Usuário na Resposta/Abaixo do Título -->
            <span id="user-name" class="text-sm font-light opacity-80 mt-1"></span>
        </header>

        <!-- Container de Mensagens - Usa flex-grow para ocupar o espaço restante -->
        <div class="chat-container flex-grow overflow-y-auto" id="chat-container">
            <!-- Mensagens serão injetadas aqui -->
        </div>

        <!-- Indicador de Carregamento e Nova Sessão -->
        <div class="p-4 border-t border-gray-200">
            <div id="loading-indicator" class="hidden text-center text-indigo-500 font-medium my-2">
                <svg class="animate-spin h-5 w-5 text-indigo-500 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Gerando resposta...
            </div>
            
            <div id="new-session-container" class="hidden text-center my-2">
                <button id="new-session-btn" class="px-4 py-2 bg-green-500 text-white font-medium rounded-lg hover:bg-green-600 transition duration-150 shadow-md">
                    Iniciar Novo Check-in Diário
                </button>
            </div>

            <!-- Input de Mensagem -->
            <div class="flex space-x-3">
                <input type="text" id="message-input" placeholder="Digite sua resposta ou uma dúvida sobre malária..." class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 shadow-inner" disabled>
                <button id="send-btn" class="flex-shrink-0 bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-xl transition duration-150 shadow-md focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Erro -->
    <div id="error-modal" class="hidden fixed inset-0 bg-red-900 bg-opacity-75 z-50 overflow-y-auto flex items-center justify-center">
        <div class="relative w-full max-w-sm mx-4 p-6 bg-white rounded-xl shadow-2xl">
            <div class="text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-red-600 mx-auto" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2h2a1 1 0 000-2H9zm-2 4h6v2H7v-2z" clip-rule="evenodd" />
                </svg>
                <h3 class="text-lg leading-6 font-medium text-red-900 mt-3">Erro de Aplicação</h3>
                <p id="error-message" class="text-sm text-gray-500 mt-2">Ocorreu um erro desconhecido.</p>
            </div>
            <div class="mt-4">
                <button id="close-error-modal" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-lg w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal do TCLE (Termo de Consentimento Livre e Esclarecido) -->
    <div id="tcle-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 overflow-y-auto flex items-center justify-center">
        <div class="relative w-full max-w-xl mx-4 my-8 p-6 bg-white rounded-3xl shadow-2xl transform transition-all duration-300">
            <div class="text-center border-b pb-4 mb-4">
                <h3 class="text-2xl font-extrabold text-green-700 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    Termo de Consentimento
                </h3>
                <p class="text-sm text-gray-500 mt-2">Sua participação é voluntária e sigilosa.</p>
            </div>
            <div class="max-h-[60vh] overflow-y-auto p-4 border rounded-xl bg-gray-50 text-left text-sm text-gray-700 space-y-3 custom-scrollbar">
                <p>Eu, o participante, confirmo que li e entendi o Termo de Consentimento Livre e Esclarecido (TCLE) referente ao projeto de monitoramento de saúde. Compreendo que meus dados de monitoramento e de saúde (como RG, CPF e histórico de Malária) serão utilizados exclusivamente para fins de pesquisa e acompanhamento epidemiológico, de forma anonimizada e sigilosa, pela equipe de saúde de Porto Velho.</p>
                <p>Fui informado sobre o objetivo do estudo, os procedimentos envolvidos (preenchimento diário de questionário via chatbot), os riscos mínimos e os benefícios potenciais (monitoramento da evolução clínica).</p>
                <p>Entendo que a minha participação é totalmente **voluntária**, e posso retirar meu consentimento a qualquer momento, sem que isso implique em qualquer prejuízo ao meu tratamento ou à continuidade da minha assistência médica.</p>
                <p>Ao marcar a caixa abaixo e clicar em "Participar", confirmo que concordo em participar do projeto.</p>
            </div>
            <div class="mt-4 pt-4 border-t">
                <div class="flex items-center mb-4">
                    <input id="tcle-consent-checkbox" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500">
                    <label for="tcle-consent-checkbox" class="ml-3 block text-base font-medium text-gray-900">Eu concordo com os termos acima.</label>
                </div>
                <button id="tcle-participar-btn" class="px-4 py-3 bg-gray-400 text-white text-base font-bold rounded-xl w-full shadow-md cursor-not-allowed" disabled>
                    Participar do Monitoramento
                </button>
            </div>
        </div>
    </div>

    <!-- Modal do Formulário de Dados Iniciais (NOVO ESTILO) -->
    <div id="form-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 overflow-y-auto flex items-center justify-center">
        <div class="relative w-full max-w-xl mx-4 my-8 p-6 bg-white rounded-3xl shadow-2xl transform transition-all duration-300">
            <!-- HEADER -->
            <div class="text-center border-b pb-4 mb-4">
                <h3 class="text-2xl font-extrabold text-indigo-700 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-indigo-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9.5 9a1.5 1.5 0 000 3h1a1.5 1.5 0 000-3h-1z" clip-rule="evenodd" />
                    </svg>
                    Dados Essenciais para o Projeto
                </h3>
                <p class="text-sm text-gray-500 mt-2">Por favor, preencha as informações para iniciar seu monitoramento. Todos os campos são necessários.</p>
            </div>

            <!-- FORM CONTENT -->
            <form id="health-form" class="space-y-6 max-h-[70vh] overflow-y-auto pr-2 custom-scrollbar">

                <!-- Seção 1: Dados Pessoais e Endereço -->
                <div class="p-4 bg-indigo-50 rounded-xl shadow-inner border border-indigo-200">
                    <h4 class="text-lg font-bold text-indigo-800 mb-4">1. Identificação e Contato</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="rg" class="block text-xs font-semibold text-gray-700">RG</label>
                            <input type="text" id="rg" placeholder="Ex: 1234567-SSP/RO" class="mt-1 block w-full p-2.5 border border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        </div>
                        <div class="col-span-1">
                            <label for="cpf" class="block text-xs font-semibold text-gray-700">CPF</label>
                            <input type="text" id="cpf" placeholder="Ex: 000.000.000-00" class="mt-1 block w-full p-2.5 border border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        </div>
                    </div>

                    <div class="mt-4">
                        <label for="endereco" class="block text-xs font-semibold text-gray-700">Endereço Completo</label>
                        <input type="text" id="endereco" placeholder="Rua, Número, Bairro" class="mt-1 block w-full p-2.5 border border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    </div>

                    <div class="grid grid-cols-3 gap-4 mt-4">
                        <div class="col-span-2">
                            <label for="cidade" class="block text-xs font-semibold text-gray-700">Cidade</label>
                            <input type="text" id="cidade" placeholder="Porto Velho" class="mt-1 block w-full p-2.5 border border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        </div>
                        <div class="col-span-1">
                            <label for="estado" class="block text-xs font-semibold text-gray-700">Estado</label>
                            <input type="text" id="estado" placeholder="RO" class="mt-1 block w-full p-2.5 border border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm uppercase">
                        </div>
                    </div>
                </div>

                <!-- Seção 2: Informações Clínicas da Malária -->
                <div class="p-4 bg-yellow-50 rounded-xl shadow-inner border border-yellow-200">
                    <h4 class="text-lg font-bold text-yellow-800 mb-4">2. Dados do Diagnóstico e Tratamento</h4>

                    <!-- NOVO: Select para Tipo de Malária -->
                    <div>
                        <label for="tipoMalaria" class="block text-xs font-semibold text-gray-700">Tipo de Malária Diagnóstico</label>
                        <select id="tipoMalaria" class="mt-1 block w-full p-2.5 border border-yellow-300 rounded-lg shadow-sm focus:ring-yellow-500 focus:border-yellow-500 text-sm bg-white">
                            <option value="" disabled selected>Selecione o tipo de Malária</option>
                            <option value="P. vivax">P. vivax</option>
                            <option value="P. falciparum">P. falciparum</option>
                            <option value="Mista">Mista (P. vivax e P. falciparum)</option>
                            <option value="Outro/Desconhecido">Outro/Desconhecido</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label for="inicioSintomas" class="block text-xs font-semibold text-gray-700">Data de Início dos Sintomas</label>
                            <input type="date" id="inicioSintomas" class="mt-1 block w-full p-2.5 border border-yellow-300 rounded-lg shadow-sm focus:ring-yellow-500 focus:border-yellow-500 text-sm">
                        </div>
                        <div>
                            <label for="dataAtendimento" class="block text-xs font-semibold text-gray-700">Data do Primeiro Atendimento</label>
                            <input type="date" id="dataAtendimento" class="mt-1 block w-full p-2.5 border border-yellow-300 rounded-lg shadow-sm focus:ring-yellow-500 focus:border-yellow-500 text-sm">
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label for="unidadeAtendimento" class="block text-xs font-semibold text-gray-700">Unidade de Saúde de Atendimento</label>
                        <input type="text" id="unidadeAtendimento" placeholder="Nome da UBS ou Centro de Saúde" class="mt-1 block w-full p-2.5 border border-yellow-300 rounded-lg shadow-sm focus:ring-yellow-500 focus:border-yellow-500 text-sm">
                    </div>

                    <div class="mt-5 space-y-3">
                        <div class="flex items-center p-3 border border-yellow-300 rounded-lg bg-white shadow-sm">
                            <input id="medicacaoDistribuida" type="checkbox" class="h-4 w-4 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500">
                            <label for="medicacaoDistribuida" class="ml-3 block text-sm font-medium text-gray-900">A medicação (incluindo Tafenoquina, se aplicável) foi distribuída?</label>
                        </div>
                        <div class="flex items-center p-3 border border-yellow-300 rounded-lg bg-white shadow-sm">
                            <input id="teveFebre" type="checkbox" class="h-4 w-4 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500">
                            <label for="teveFebre" class="ml-3 block text-sm font-medium text-gray-900">Você apresentou febre no dia do atendimento?</label>
                        </div>
                    </div>
                </div>

                <!-- Seção 3: Histórico de Comorbidades -->
                <div class="p-4 bg-red-50 rounded-xl shadow-inner border border-red-200">
                    <h4 class="text-lg font-bold text-red-800 mb-4">3. Comorbidades (Condições Crônicas)</h4>

                    <p class="text-sm text-gray-600 mb-4">Marque as condições de saúde que você já possui. Essa informação é importante para o monitoramento.</p>

                    <div class="space-y-3">
                        <div class="flex items-center p-3 border border-red-300 rounded-lg bg-white shadow-sm">
                            <input id="hipertenso" type="checkbox" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <label for="hipertenso" class="ml-3 block text-sm font-medium text-gray-900">Sou hipertenso(a) (pressão alta).</label>
                        </div>
                        <div class="flex items-center p-3 border border-red-300 rounded-lg bg-white shadow-sm">
                            <input id="diabetes" type="checkbox" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <label for="diabetes" class="ml-3 block text-sm font-medium text-gray-900">Tenho diabetes (açúcar elevado no sangue).</label>
                        </div>
                    </div>
                </div>

                <!-- BOTÃO DE AÇÃO -->
                <div class="pt-4 sticky bottom-0 bg-white border-t -mx-6 px-6">
                    <button id="save-form-btn" type="button" class="px-4 py-3 bg-indigo-600 text-white text-base font-bold rounded-xl w-full shadow-lg hover:bg-indigo-700 transition duration-150 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.103A.89.89 0 0021 6.168v7.832a2 2 0 01-2 2H5a2 2 0 01-2-2V6.168c0-.68.397-1.3.882-1.615l4.404-2.202a1.2 1.2 0 011.096 0l4.404 2.202a.89.89 0 00.882 1.615z"/>
                        </svg>
                        Salvar Dados e Prosseguir para o Termo de Consentimento
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Script JavaScript -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, getDocs, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// Variaveis de configuracao do seu projeto, essas variaveis sao privadas, nunca as exponha.
const firebaseConfig = {
    apiKey: "AIzaSyCEW-C1FavyFqjabMjmS-JVo2fLXHNt5Yg",
    authDomain: "meuaplicativosaude.firebaseapp.com",
    projectId: "meuaplicativosaude",
    storageBucket: "meuaplicativosaude.firebasestorage.app",
    messagingSenderId: "547845597696",
    appId: "1:547845597696:web:7942056f2d48601fa086e5",
    measurementId: "G-MYE47X3LNH"
};

// Chave de API do Gemini, nunca a exponha.
const geminiApiKey = "AIzaSyBeLGZcfbhn9lYFzsy6YWDI8PNquvZ9aE0";

// Inicializar Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Variável para armazenar o estado do usuário
let currentUser = null;

// Elementos do DOM
const loginScreen = document.getElementById('login-screen');
const chatScreen = document.getElementById('chat-screen');
const googleSigninBtn = document.getElementById('google-signin-btn');
const chatContainer = document.querySelector('.chat-container');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const loadingIndicator = document.getElementById('loading-indicator');
const errorModal = document.getElementById('error-modal');
const errorMessageElem = document.getElementById('error-message');
const closeErrorModalBtn = document.getElementById('close-error-modal');
const newSessionBtn = document.getElementById('new-session-btn');
const newSessionContainer = document.getElementById('new-session-container');
const reminderContainer = document.getElementById('reminder-container');
const enableRemindersBtn = document.getElementById('enable-reminders-btn');
const formModal = document.getElementById('form-modal');
const saveFormBtn = document.getElementById('save-form-btn');
const userNameElem = document.getElementById('user-name');
// NOVAS VARIÁVEIS PARA O TCLE
const tcleModal = document.getElementById('tcle-modal');
const tcleConsentCheckbox = document.getElementById('tcle-consent-checkbox');
const tcleParticiparBtn = document.getElementById('tcle-participar-btn');

// ==========================================================
// ESTRUTURA DE PERGUNTAS COM OPÇÕES DE BOTÃO (ATUALIZADA)
// ==========================================================
const dailyQuestions = [
    // I. Avaliação Geral e Sintomas Principais (Q1 a Q3)
    { 
        text: "1. Como você se sente no geral hoje em comparação com ontem e com o início do tratamento?",
        type: "select",
        options: ["Sinto-me muito melhor", "Sinto-me um pouco melhor", "Igual a ontem", "Sinto-me pior", "Não sei dizer"]
    },
    {
        text: "2. A febre diminuiu ou está mais controlada? Qual foi a temperatura máxima que você mediu nas últimas 24 horas?",
        type: "select",
        options: ["Não tive febre", "Diminuiu e está controlada (máx 37.5°C)", "Persiste, mas com melhora (máx 38.5°C)", "Persiste alta e intensa (acima de 38.5°C)"],
        warning: (response) => response.includes("acima de 38.5°C") ? "**Sinal de Alerta:** Febre alta persistente. Por favor, procure atendimento médico IMEDIATO." : null
    },
    {
        text: "3. Você ainda tem calafrios e tremores intensos? Eles estão menos frequentes ou menos intensos do que antes?",
        type: "select",
        options: ["Não tenho mais", "Estão muito mais leves/raros", "Estão iguais a antes", "Estão mais intensos/frequentes"]
    },

    // II. Outros Sintomas Comuns e Nível de Energia (Q4 a Q6)
    {
        text: "4. As dores de cabeça e as dores no corpo (musculares ou nas articulações) estão mais leves ou continuam fortes?",
        type: "select",
        options: ["Não sinto mais dores", "Dores muito mais leves", "Continuam fortes", "Estão piores"]
    },
    {
        text: "5. Você tem conseguido se alimentar e beber líquidos normalmente? Houve vômitos ou diarreia nas últimas horas?",
        type: "select",
        options: ["Sim, alimentação e hidratação normais", "Consigo comer e beber, mas com dificuldade", "Tive vômitos ou diarreia isolados", "Vômitos ou diarreia persistentes e intensos"],
        warning: (response) => response.includes("persistentes e intensos") ? "**Sinal de Alerta:** Vômitos/Diarreia intensos. Risco de desidratação e má absorção da medicação. Procure atendimento médico IMEDIATO." : null
    },
    {
        text: "6. Como está seu nível de energia e disposição? Você se sente muito cansado, com fraqueza extrema ou consegue realizar atividades simples com menos dificuldade?",
        type: "select",
        options: ["Sinto-me com energia normal/melhor", "Ainda sinto fraqueza, mas consigo me mover", "Cansaço e fraqueza extremas, dificuldade para atividades simples"]
    },

    // III. Sinais de Alerta para Buscar Ajuda Médica Imediata (Malária Grave) (Q7 a Q12)
    {
        text: "7. Você notou alguma coloração amarelada na pele ou nos olhos (icterícia)?",
        type: "select",
        options: ["Não", "Sim"],
        warning: (response) => response === "Sim" ? "**SINAL DE ALERTA GRAVE:** Procure atendimento médico IMEDIATO." : null
    },
    {
        text: "8. Sua respiração está normal ou você tem sentido falta de ar, dificuldade para respirar ou respiração muito rápida e superficial, mesmo em repouso?",
        type: "select",
        options: ["Respiração normal", "Sinto leve dificuldade ao fazer esforço", "Sinto falta de ar em repouso ou dificuldade intensa para respirar"],
        warning: (response) => response.includes("dificuldade intensa") ? "**SINAL DE ALERTA GRAVE:** Procure atendimento médico IMEDIATO." : null
    },
    {
        text: "9. Você sentiu tonturas intensas, desmaios, confusão mental (dificuldade de raciocínio, desorientação), sonolência excessiva ou dificuldade para se manter acordado?",
        type: "select",
        options: ["Não", "Sim, senti tonturas/sonolência leves", "Sim, senti confusão mental, tontura intensa ou desmaios"],
        warning: (response) => response.includes("confusão mental") || response.includes("desmaios") ? "**SINAL DE ALERTA GRAVÍSSIMO:** Procure atendimento médico IMEDIATO." : null
    },
    {
        text: "10. Você está urinando menos do que o normal, sua urina está muito escura ou notou inchaço nas pernas e tornozelos?",
        type: "select",
        options: ["Normal", "Sim, estou urinando menos e/ou urina escura"],
        warning: (response) => response.includes("Sim") ? "**SINAL DE ALERTA GRAVE:** Pode indicar problema renal. Procure atendimento médico IMEDIATO." : null
    },
    {
        text: "11. Há sangramentos incomuns (pelo nariz, gengivas, manchas roxas na pele, urina ou fezes com sangue)?",
        type: "select",
        options: ["Não", "Sim"],
        warning: (response) => response === "Sim" ? "**SINAL DE ALERTA GRAVE:** Procure atendimento médico IMEDIATO." : null
    },
    {
        text: "12. Você sentiu dores intensas no abdômen, no peito ou nas costas, ou sensibilidade aumentada na barriga?",
        type: "select",
        options: ["Não", "Senti dor leve e passageira", "Senti dor intensa e persistente no abdômen, peito ou costas"],
        warning: (response) => response.includes("intensa e persistente") ? "**SINAL DE ALERTA GRAVE:** Procure atendimento médico IMEDIATO." : null
    },

    // IV. Adesão ao Tratamento e Acompanhamento (Q13 e Q14)
    {
        text: "13. Você está tomando todos os medicamentos exatamente como o médico prescreveu, nos horários certos e sem esquecer nenhuma dose?",
        type: "select",
        options: ["Sim, corretamente", "Esqueci doses ou errei o horário", "Parei de tomar a medicação"]
    },
    {
        text: "14. A medicação está causando algum efeito colateral intenso e insuportável (além do que foi avisado pelo médico)?",
        type: "select",
        options: ["Não, os efeitos são leves/suportáveis", "Sim, os efeitos colaterais são intensos e insuportáveis"],
        warning: (response) => response.includes("insuportáveis") ? "Importante: Entre em contato com a Unidade de Saúde para avaliação e possível ajuste." : null
    },
    
    // V. BUSCA POR AJUDA E AUTOMEDICAÇÃO (NOVAS PERGUNTAS)
    {
        text: "15. Desde o seu último check-in (ou atendimento), você precisou buscar atendimento em alguma Unidade Básica de Saúde (UBS), Unidade de Pronto Atendimento (UPA) ou Hospital?",
        type: "select",
        options: ["Não, não procurei ajuda", "Sim, procurei e fui reavaliado(a)", "Estou a caminho da unidade agora"],
        warning: (response) => response.includes("a caminho") ? "Por favor, continue nos informando após a reavaliação médica. Tenha um atendimento seguro." : null
    },
    {
        text: "16. Você tomou algum medicamento para febre, dor ou outros sintomas que NÃO FOI receitado especificamente para o tratamento da malária?",
        type: "select",
        options: ["Não, apenas a medicação prescrita", "Sim, tomei (Ex: Paracetamol, Dipirona, vitaminas)", "Sim, tomei antibióticos ou outros remédios fortes por conta própria"],
        warning: (response) => response.includes("por conta própria") ? "**Atenção!** A automedicação pode ser perigosa e interferir no tratamento da malária. Por favor, evite tomar remédios não prescritos." : null
    },

    // VI. CONTROLE DE CURA (DINÂMICA)
    {
        text: "17. A data recomendada para seu próximo exame de Gota Espessa de controle é: [DATA CALCULADA]. Você pretende comparecer ao seu retorno/exame conforme indicação médica?",
        type: "select",
        options: ["Sim, irei na data indicada", "Já realizei (e deu negativo)", "Já realizei (e deu positivo)", "Não poderei comparecer"]
    }
];
// ==========================================================


// Variável para rastrear o estado da conversa e dados do usuário
let conversationStep = 0;
let userResponses = {};
let isWaitingForSummary = false;
let userProfileData = null;

// VARIÁVEIS PARA O TEMPORIZADOR DE INATIVIDADE
let inactivityTimer;
const INACTIVITY_TIMEOUT = 3 * 60 * 1000; // 5 minutos em milissegundos
let isSessionActive = false; // Começa como inativa até o login e início do questionário

// Função para mostrar o modal de erro
function showError(message) {
    errorMessageElem.innerHTML = message; // Usando innerHTML para permitir formatação de texto (negrito)
    errorModal.classList.remove('hidden');
}

closeErrorModalBtn.onclick = () => {
    errorModal.classList.add('hidden');
};

// Função para rolar para o final do chat
function scrollToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Funções de formato de data e hora
function formatTimestamp(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate();
    const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };
    const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
    const formattedDate = date.toLocaleDateString('pt-BR', dateOptions);
    const formattedTime = date.toLocaleTimeString('pt-BR', timeOptions);
    return `${formattedDate} ${formattedTime}`;
}

function getFormattedDate() {
    const today = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return today.toLocaleDateString('pt-BR', options);
}

/**
 * Calcula a próxima data de controle de Gota Espessa (Dia 3, 7, 14 ou 28)
 * com base na data do primeiro atendimento e na data atual.
 * @param {string} firstConsultationDateString - Data do primeiro atendimento (YYYY-MM-DD).
 * @returns {string} Texto indicando o próximo controle necessário ou "Completo" se já passou o D28.
 */
function calculateNextControlDate(firstConsultationDateString) {
    if (!firstConsultationDateString) return "Data não fornecida. Por favor, procure sua UBS.";

    const initialDate = new Date(firstConsultationDateString + 'T00:00:00'); // Garante que é meia-noite
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const controls = [3, 7, 14, 28]; // Dias para o controle
    
    // Adiciona 1 dia porque o controle D+N ocorre N dias APÓS o D0 (dia do atendimento)
    // O D1 é o dia seguinte ao D0.
    const getControlDate = (day) => {
        const controlDate = new Date(initialDate);
        controlDate.setDate(initialDate.getDate() + day);
        return controlDate;
    };

    let nextControl = null;

    for (const day of controls) {
        const controlDate = getControlDate(day);
        
        // Verifica se a data de controle é no futuro ou hoje (mas não no passado)
        if (controlDate >= today) {
            nextControl = { day: day, date: controlDate };
            break; // Encontrou o próximo controle
        }
    }

    if (nextControl) {
        const controlDate = nextControl.date;
        const formattedDate = controlDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        
        // Verifica se o controle é hoje
        if (controlDate.getTime() === today.getTime()) {
            return `HOJE (Dia ${nextControl.day}, ${formattedDate})`;
        } else {
            return `Dia ${nextControl.day} (${formattedDate})`;
        }
    }

    // Se a data de controle D28 já passou
    const d28Date = getControlDate(28);
    if (d28Date < today) {
        return "Controle D28 já realizado. Continue o monitoramento, mas o controle laboratorial primário está completo.";
    }

    return "Erro no cálculo. Procure a unidade de saúde para confirmar a data correta.";
}

// Função para exibir mensagem no chat
function displayMessage(message, isUser, timestamp) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `my-2 p-2 rounded max-w-sm whitespace-pre-wrap ${isUser ? 'user-message self-end' : 'gemini-message self-start'}`;

    const textNode = document.createElement('p');
    textNode.textContent = message;
    messageDiv.appendChild(textNode);

    const timestampNode = document.createElement('span');
    timestampNode.className = `text-xs mt-1 block ${isUser ? 'text-gray-400' : 'text-gray-500'}`;
    
    const dateOptionsFallback = { year: 'numeric', month: '2-digit', day: '2-digit' };
    const timeOptionsFallback = { hour: '2-digit', minute: '2-digit', hour12: false };
    const now = new Date();
    const fallbackDisplay = `${now.toLocaleDateString('pt-BR', dateOptionsFallback)} ${now.toLocaleTimeString('pt-BR', timeOptionsFallback)}`;

    timestampNode.textContent = timestamp 
        ? formatTimestamp(timestamp) 
        : fallbackDisplay; 

    messageDiv.appendChild(timestampNode);

    chatContainer.appendChild(messageDiv);
    scrollToBottom();
}

// ==========================================================
// FUNÇÃO ADAPTADA PARA EXIBIR PERGUNTA E BOTÕES INLINE
// ==========================================================
async function displayQuestionWithButtons(question) {
    const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/chat_messages`);
    let questionText = question.text;
    
    // Lógica para a PERGUNTA DINÂMICA (Q17)
    if (question.text.includes("[DATA CALCULADA]") && userProfileData && userProfileData.dataAtendimento) {
        const nextControlInfo = calculateNextControlDate(userProfileData.dataAtendimento);
        questionText = question.text.replace("[DATA CALCULADA]", nextControlInfo);
    }

    // 1. Adiciona a pergunta ao Firestore (e ao chat via onSnapshot)
    await addDoc(chatCollectionRef, { text: questionText, isUser: false, timestamp: serverTimestamp() });
    
    // 2. Desabilita o input enquanto espera a resposta de botão/texto
    messageInput.disabled = true;
    sendBtn.disabled = true;

    // Se for uma pergunta de seleção, adiciona os botões no DOM
    if (question.type === 'select' && question.options) {
        // Esperamos um pequeno tempo para garantir que a mensagem foi renderizada.
        await new Promise(resolve => setTimeout(resolve, 50)); 
        
        const lastMessageDiv = chatContainer.lastElementChild;
        if (!lastMessageDiv || lastMessageDiv.classList.contains('user-message')) {
            console.error("Não foi possível encontrar a última mensagem do bot para anexar botões.");
            messageInput.disabled = false;
            sendBtn.disabled = false;
            return;
        }

        const buttonsDiv = document.createElement('div');
        // Identificador exclusivo para remover os botões após a resposta
        buttonsDiv.classList.add('response-buttons', 'mt-2', 'p-2', 'bg-white', 'rounded-b-lg', 'shadow-md');
        
        question.options.forEach(optionText => {
            const button = document.createElement('button');
            button.className = 'w-full text-left bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-medium py-2 px-4 rounded-lg my-1 transition duration-150 ease-in-out shadow-sm text-sm';
            button.textContent = optionText;
            button.onclick = () => processButtonResponse(optionText);
            buttonsDiv.appendChild(button);
        });

        // Adiciona os botões ao final da div da mensagem do Bot
        lastMessageDiv.appendChild(buttonsDiv);
        scrollToBottom();

    } else {
        // Se for tipo 'text', reabilita o input
        messageInput.disabled = false;
        sendBtn.disabled = false;
    }
}
// ==========================================================

// ==========================================================
// FUNÇÃO PARA PROCESSAR RESPOSTAS DE BOTÃO (AGORA REMOVE O BOTÃO)
// ==========================================================
async function processButtonResponse(response) {
    if (!currentUser || isWaitingForSummary) return;

    // 1. Remove os botões de resposta da tela
    const buttons = chatContainer.querySelectorAll('.response-buttons');
    buttons.forEach(btn => btn.remove());
    
    // 2. Reabilita o input e simula o envio de mensagem do usuário
    messageInput.disabled = false;
    sendBtn.disabled = false;
    
    await sendMessage(response, true); 
}
// ==========================================================


// FUNÇÕES DO TEMPORIZADOR
function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    if (currentUser && isSessionActive) {
        inactivityTimer = setTimeout(endSession, INACTIVITY_TIMEOUT);
    }
}

async function endSession() {
    if (!currentUser || !isSessionActive) return;

    isSessionActive = false;
    messageInput.disabled = true;
    sendBtn.disabled = true;

    // Remove botões existentes ao encerrar
    chatContainer.querySelectorAll('.response-buttons').forEach(btn => btn.remove());

    const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/chat_messages`);
    const endMessage = "Sessão encerrada por inatividade. Caso queira responder novamente para fins de acompanhamento da evolução clínica, registro diário ou esclarecer dúvidas acerca do tratamento da Malária, atualize a página!";

    await addDoc(chatCollectionRef, { text: endMessage, isUser: false, timestamp: serverTimestamp() });
    conversationStep = -1; 
}

// Função para gerar uma resposta do chatbot usando a API Gemini
async function getGeminiResponse(prompt) {
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;
    const payload = { contents: [{ parts: [{ text: prompt }] }] };

    let retries = 0;
    const maxRetries = 3;
    let success = false;
    let responseData;

    while (!success && retries < maxRetries) {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            if (!response.ok) { throw new Error(`Erro HTTP! status: ${response.status}`); }
            responseData = await response.json();
            success = true;
        } catch (e) {
            console.error("Erro na chamada da API:", e);
            retries++;
            if (retries < maxRetries) {
                const delay = Math.pow(2, retries) * 1000;
                await new Promise(res => setTimeout(res, delay));
            } else { throw e; }
        }
    }
    if (!success) { throw new Error('Falha na conexão com a API após várias tentativas.'); }
    const candidate = responseData.candidates?.[0];
    const text = candidate?.content?.parts?.[0]?.text;
    return text || "Não foi possível gerar uma resposta. Tente novamente.";
}

// ==========================================================
// FUNÇÃO SENDMESSAGE ADAPTADA SEM MENSAGEM DE RECONHECIMENTO ENTRE RESPOSTAS
// ==========================================================
async function sendMessage(manualMessage = null, isButtonResponse = false) {
    if (!currentUser) {
        showError("Você precisa estar logado para enviar mensagens.");
        return;
    }

    const message = manualMessage || messageInput.value.trim();
    if (message === '' || isWaitingForSummary) return;

    // Lógica para reiniciar o questionário após inatividade
    if (conversationStep === -1) {
        // Limpa botões existentes
        chatContainer.querySelectorAll('.response-buttons').forEach(btn => btn.remove());
        
        messageInput.value = '';
        messageInput.disabled = true;
        sendBtn.disabled = true;
        loadingIndicator.classList.remove('hidden');

        const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/chat_messages`);
        await addDoc(chatCollectionRef, { text: message, isUser: true, timestamp: serverTimestamp() });
        
        await startNewSession(); 
        loadingIndicator.classList.add('hidden');
        resetInactivityTimer();
        return; 
    }

    resetInactivityTimer(); 

    if (!isButtonResponse) {
        messageInput.value = '';
    }
    
    loadingIndicator.classList.remove('hidden');

    // Variável para rastrear o índice da pergunta antes de avançar o passo
    let questionIndexBeforeAdvance = -1;

    try {
        const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/chat_messages`);
        
        // 1. Salva a mensagem do usuário
        await addDoc(chatCollectionRef, { text: message, isUser: true, timestamp: serverTimestamp() });

        const currentQuestionIndex = conversationStep;
        questionIndexBeforeAdvance = currentQuestionIndex; // Captura o índice antes de qualquer tentativa de avanço
        
        if (currentQuestionIndex < dailyQuestions.length) {
            const currentQuestion = dailyQuestions[currentQuestionIndex];

            // 2. Salva a resposta do usuário
            userResponses[currentQuestionIndex] = message;

            // 3. Verifica e envia o Alerta
            if (currentQuestion.warning) {
                const warningMessage = currentQuestion.warning(message);
                if (warningMessage) {
                    await addDoc(chatCollectionRef, { text: warningMessage, isUser: false, timestamp: serverTimestamp() });
                }
            }
            
            // 4. MENSAGEM DE RECONHECIMENTO REMOVIDA AQUI!

            // 5. Avança o passo (SOMENTE APÓS O SUCESSO DO REGISTRO)
            conversationStep++;
            const nextQuestion = dailyQuestions[conversationStep];

            if (nextQuestion) {
                // 6. Exibe a próxima pergunta
                await displayQuestionWithButtons(nextQuestion);
                
            } else {
                // Fim do questionário
                await generateSummary(currentUser);
            }

        } else {
            // Se o questionário já foi concluído (Lógica de Malária e Bate-papo)
            const malariaKeywords = ["malária", "malaria", "sintomas", "tratamento", "diagnóstico", "prevenção", "dúvida", "exame"];
            const isMalariaQuestion = malariaKeywords.some(keyword => message.toLowerCase().includes(keyword));

            if (isMalariaQuestion) {
                const prompt = `Com base nas informações do Ministério da Saúde sobre malária em https://www.gov.br/saude/pt-br/assuntos/saude-de-a-a-z/m/malaria ou outra autoridade internacional referência no assunto, gere uma resposta detalhada, resumida e amigável sobre a pergunta: "${message}".`;
                const botResponse = await getGeminiResponse(prompt);
                await addDoc(chatCollectionRef, { text: botResponse, isUser: false, timestamp: serverTimestamp() });
            } else {
                const prompt = `Responda de forma amigável e breve à seguinte mensagem do usuário, sem iniciar um novo questionário: "${message}".`;
                const botResponse = await getGeminiResponse(prompt);
                await addDoc(chatCollectionRef, { text: botResponse, isUser: false, timestamp: serverTimestamp() });
            }
        }

    } catch (error) {
        console.error("Erro ao enviar mensagem ou obter resposta:", error);
        
        let customErrorMsg = "Não foi possível enviar a mensagem ou obter a resposta do chatbot. Tente novamente mais tarde.";

        if (questionIndexBeforeAdvance !== -1 && questionIndexBeforeAdvance < dailyQuestions.length) {
            // Se a falha ocorreu durante o processamento de uma pergunta específica (antes do avanço do 'conversationStep')
            const failedQuestionNum = questionIndexBeforeAdvance + 1;
            customErrorMsg = `Ocorreu um erro ao registrar sua resposta para a **Pergunta ${failedQuestionNum}**. Por favor, tente enviar a mensagem novamente. Sua sessão **não avançou** e você pode **retentar** a resposta.`;
        }

        showError(customErrorMsg);
        // Reabilita o input e o botão de envio
        messageInput.disabled = false;
        sendBtn.disabled = false;
    } finally {
        loadingIndicator.classList.add('hidden');
    }
}
// ==========================================================

async function generateSummary(user) {
    isWaitingForSummary = true;
    messageInput.disabled = true;
    sendBtn.disabled = true;
    clearTimeout(inactivityTimer); 

    const formattedDate = getFormattedDate();

    // Remove botões de qualquer pergunta anterior que possa ter ficado
    chatContainer.querySelectorAll('.response-buttons').forEach(btn => btn.remove());


    const summaryPrompt = `Gere um relatório detalhado com a seguinte estrutura e informações:
**Data:** ${formattedDate}
**Fonte das Informações:** Respostas a questionário de saúde.
---
### **1. Análise das Respostas Individuais:**
${Object.keys(userResponses).map(key => {
    let questionText = dailyQuestions[key].text;
    const responseText = userResponses[key];

    // Trata a pergunta dinâmica Q17
    if (parseInt(key) === dailyQuestions.length - 1 && questionText.includes("[DATA CALCULADA]")) {
        questionText = questionText.replace("[DATA CALCULADA]", calculateNextControlDate(userProfileData.dataAtendimento));
    }

    return `* **Pergunta ${parseInt(key) + 1}: ${questionText} Resposta: ${responseText}**`
}).join('\n')}
---
### **2. Avaliação Clínica Baseada em Expertise Médica:**
(Gere um parágrafo que resume a situação clínica com base em todas as respostas.)
---
### **3. Sintomas Relatados e Avaliação da Gravidade:**
(Gere um parágrafo que liste os sintomas relatados ou a ausência deles e avalie a gravidade. **DESTAQUE se a pergunta 7 a 12 (Sinais de Alerta) foi respondida com uma opção que indica gravidade.**)
---
### **4. Conduta do Paciente:**
(Gere um parágrafo que descreva as ações do paciente com base nas respostas, **incluindo se houve automedicação e se buscou ajuda em UBS/UPA**.)
---
### **5. Conclusão e Recomendações:**
(Gere uma conclusão forte. Se os sintomas (como febre alta, vômito, diarreia, calafrios) forem persistentes ou indicativos de gravidade, a conclusão deve ser uma forte recomendação para o paciente procurar a unidade de saúde mais próxima, com urgência. Se os sintomas não forem graves ou se o paciente estiver se sentindo bem, a conclusão deve indicar que não é necessário procurar uma unidade de saúde, mas sim continuar se hidratando e fazendo uso correto da medicação, se aplicável e indique se houve evolução clinica entre o monitoramento anterior e o atual, caso exista.)
---
### **6. Informe sobre o tratamento da malária:**
(Gere um parágrafo que descreva o que é a malária, seu tratamento e caso necessite falar a respeito do tratamento, do diaginóstico e do estado clínico apresentado, pode ser feito por aqui, basta formular a sua sua pergunta!)

`;

    const botResponse = await getGeminiResponse(summaryPrompt);

    const checkinRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/checkin_status/daily_status`);
    await setDoc(checkinRef, { lastCheckin: serverTimestamp(), summary: botResponse });

    const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/chat_messages`);
    
    await addDoc(chatCollectionRef, { text: "✨ Relatório Detalhado:\n" + botResponse, isUser: false, timestamp: serverTimestamp() });
    
    const finalQuestion = "Agradecemos sua participação! Espero que seu estado clínico evolua rapidamente e sua saúde seja restabelecida. Estamos trabalhando fortemente para erradicar a Malária em Porto Velho e sua participação é de fundamental importância, conte conosco! Estaremos sempre à disposição. Fique a vontade para tirar dúvidas com a nossa Inteligência Artificial.";
    await addDoc(chatCollectionRef, { text: finalQuestion, isUser: false, timestamp: serverTimestamp() });

    isWaitingForSummary = false;
    messageInput.disabled = false;
    sendBtn.disabled = false;
    newSessionContainer.classList.remove('hidden');
    conversationStep = dailyQuestions.length;
    resetInactivityTimer(); 
}

async function startNewSession() {
    if (!currentUser) {
        showError("Você precisa estar logado para iniciar uma nova sessão.");
        return;
    }
    loadingIndicator.classList.remove('hidden');
    try {
        const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/chat_messages`);
        
        // Limpar respostas antigas
        userResponses = {};
        conversationStep = 0;
        
        const initialMessage = `Olá ${userProfileData?.nome || currentUser.displayName}! Bem-vindo(a) ao seu Check-up de Acompanhamento Diário de Malária para o dia ${getFormattedDate()}. Lembre-se, este não substitui o médico. Por favor, responda as perguntas com atenção.`;
        await addDoc(chatCollectionRef, { text: initialMessage, isUser: false, timestamp: serverTimestamp() });
        
        newSessionContainer.classList.add('hidden');
        isSessionActive = true;
        
        // Iniciar com a primeira pergunta
        await displayQuestionWithButtons(dailyQuestions[0]);
        
    } catch (error) {
        console.error("Erro ao iniciar nova sessão:", error);
        showError("Não foi possível iniciar uma nova sessão. Tente novamente.");
    } finally {
        loadingIndicator.classList.add('hidden');
        resetInactivityTimer();
    }
}

// ==========================================================
// FUNÇÕES DE TCLE (Com tratamento para primeiro acesso)
// ==========================================================
async function checkTcleStatus(user) {
    const tcleRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/consent/tcle`);
    try {
        const tcleDoc = await getDoc(tcleRef);
        // Se o documento existe E o campo 'accepted' é true, retorna true.
        // Caso contrário (documento não existe ou accepted é false/nulo), retorna false.
        return tcleDoc.exists() && tcleDoc.data().accepted === true;
    } catch (e) {
        console.error("Erro ao verificar status do TCLE:", e);
        return false; 
    }
}

async function showTcleModal() {
    tcleConsentCheckbox.checked = false;
    tcleParticiparBtn.disabled = true;
    tcleModal.classList.remove('hidden');
}

tcleConsentCheckbox.onchange = () => {
    tcleParticiparBtn.disabled = !tcleConsentCheckbox.checked;
};

tcleParticiparBtn.onclick = async () => {
    if (!tcleConsentCheckbox.checked) return;

    loadingIndicator.classList.remove('hidden');
    try {
        const tcleRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/consent/tcle`);
        await setDoc(tcleRef, { accepted: true, acceptedAt: serverTimestamp() });
        tcleModal.classList.add('hidden');
        
        // Próxima etapa: Carregar perfil e verificar formulário
        await loadUserProfile(currentUser); 
    } catch (e) {
        console.error("Erro ao registrar consentimento do TCLE:", e);
        showError("Não foi possível registrar seu consentimento. Tente novamente.");
    } finally {
        loadingIndicator.classList.add('hidden');
    }
};

// ==========================================================
// FUNÇÕES DE CADASTRO (FORMULÁRIO)
// ==========================================================
async function loadUserProfile(user) {
    loadingIndicator.classList.remove('hidden');
    const userProfileRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/profile/info`);
    
    try {
        const profileDoc = await getDoc(userProfileRef);
        if (profileDoc.exists()) {
            userProfileData = profileDoc.data();
            userNameElem.textContent = userProfileData.nome || user.displayName;
            chatScreen.classList.remove('hidden');
            loginScreen.classList.add('hidden');
            tcleModal.classList.add('hidden');
            // Próxima etapa: Verificar sessão diária
            await checkDailySession(user);
        } else {
            // Se o perfil não existe, mostra o formulário de cadastro
            chatScreen.classList.add('hidden');
            tcleModal.classList.add('hidden');
            loginScreen.classList.add('hidden');
            showFormModal();
        }
    } catch (e) {
        console.error("Erro ao carregar perfil do usuário:", e);
        showError("Erro ao carregar seu perfil. Tente recarregar a página.");
    } finally {
        loadingIndicator.classList.add('hidden');
    }
}

function showFormModal() {
    // Preenche campos se houver dados parciais ou sugestões do Google
    document.getElementById('form-nome').value = currentUser.displayName || '';
    document.getElementById('form-email').value = currentUser.email || '';
    
    formModal.classList.remove('hidden');
}

saveFormBtn.onclick = async () => {
    const nome = document.getElementById('form-nome').value.trim();
    const dataNascimento = document.getElementById('form-data-nascimento').value.trim();
    const dataAtendimento = document.getElementById('form-data-atendimento').value.trim();
    const municipio = document.getElementById('form-municipio').value.trim();

    if (!nome || !dataNascimento || !dataAtendimento || !municipio) {
        showError("Por favor, preencha todos os campos do formulário de cadastro.");
        return;
    }

    loadingIndicator.classList.remove('hidden');
    try {
        const userProfileRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/profile/info`);
        
        userProfileData = {
            nome: nome,
            email: currentUser.email,
            dataNascimento: dataNascimento,
            dataAtendimento: dataAtendimento, // Data do D0 para cálculo do controle
            municipio: municipio,
            createdAt: serverTimestamp()
        };

        await setDoc(userProfileRef, userProfileData);
        formModal.classList.add('hidden');

        // Confirma o nome na tela de chat
        userNameElem.textContent = nome;
        
        // Próxima etapa: Iniciar sessão diária
        await checkDailySession(currentUser);

    } catch (e) {
        console.error("Erro ao salvar formulário:", e);
        showError("Não foi possível salvar seu cadastro. Tente novamente.");
    } finally {
        loadingIndicator.classList.add('hidden');
    }
};

// ==========================================================
// FUNÇÕES DE SESSÃO
// ==========================================================
async function checkDailySession(user) {
    loadingIndicator.classList.remove('hidden');
    const checkinRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/checkin_status/daily_status`);
    const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/chat_messages`);

    try {
        const checkinDoc = await getDoc(checkinRef);
        const lastCheckinTimestamp = checkinDoc.exists() ? checkinDoc.data().lastCheckin : null;
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (lastCheckinTimestamp) {
            const lastCheckinDate = lastCheckinTimestamp.toDate();
            lastCheckinDate.setHours(0, 0, 0, 0);

            if (lastCheckinDate.getTime() === today.getTime()) {
                // Sessão de hoje já concluída
                conversationStep = dailyQuestions.length; // Garante que está no modo bate-papo
                messageInput.disabled = false;
                sendBtn.disabled = false;
                newSessionContainer.classList.remove('hidden');
                
                // Exibe a última mensagem de relatório (se houver) e mensagem final
                const summary = checkinDoc.data().summary || "Relatório do último check-in não disponível.";
                const finalMsg = "Você já concluiu o check-up de hoje. Fique à vontade para tirar dúvidas sobre a Malária com a nossa Inteligência Artificial ou inicie uma nova sessão amanhã. (O último relatório detalhado está acima)";
                
                // Garante que o chat está limpo e carrega o histórico
                chatContainer.innerHTML = '';
                await loadChatHistory(user); 

                await addDoc(chatCollectionRef, { text: finalMsg, isUser: false, timestamp: serverTimestamp() });
                
                loadingIndicator.classList.add('hidden');
                isSessionActive = true; 
                resetInactivityTimer();
                return;
            }
        }

        // Se a sessão não foi feita hoje, inicia uma nova
        await startNewSession(); 

    } catch (e) {
        console.error("Erro ao verificar sessão diária:", e);
        showError("Erro ao verificar sua sessão. Tente novamente.");
        loadingIndicator.classList.add('hidden');
    }
}

async function loadChatHistory(user) {
    const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/chat_messages`);
    const q = query(chatCollectionRef, orderBy('timestamp', 'asc'));

    // Limpa o chat antes de carregar
    chatContainer.innerHTML = '';

    const querySnapshot = await getDocs(q);
    querySnapshot.forEach((doc) => {
        const data = doc.data();
        displayMessage(data.text, data.isUser, data.timestamp);
    });
}

// ==========================================================
// AUTENTICAÇÃO E INICIALIZAÇÃO DO APLICATIVO (FLUXO ALTERADO)
// ==========================================================

const provider = new GoogleAuthProvider();

googleSigninBtn.onclick = async () => {
    try {
        // A autenticação chama onAuthStateChanged, que por sua vez chama checkUserStatus
        await signInWithPopup(auth, provider);
    } catch (error) {
        console.error("Erro de login com Google:", error);
        showError("Falha ao fazer login com o Google. Tente novamente.");
    }
};

// Função para iniciar o fluxo após o login/re-autenticação
async function checkUserStatus(user) {
    currentUser = user;
    if (user) {
        // 1. Verificar TCLE (Primeira etapa obrigatória)
        const tcleAccepted = await checkTcleStatus(user);
        
        if (tcleAccepted) {
            // 2. Se o TCLE foi aceito, carrega o perfil (que verificará se o form está preenchido)
            await loadUserProfile(user); 
        } else {
            // 2. Se o TCLE NÃO foi aceito (incluindo o primeiro acesso), mostra o modal do TCLE.
            loginScreen.classList.add('hidden');
            chatScreen.classList.add('hidden'); 
            formModal.classList.add('hidden'); 
            await showTcleModal();
        }
    } else {
        // Não logado: Exibe a tela de login
        currentUser = null;
        chatScreen.classList.add('hidden');
        tcleModal.classList.add('hidden');
        formModal.classList.add('hidden');
        loginScreen.classList.remove('hidden');
        clearTimeout(inactivityTimer);
    }
}

// Listener de autenticação do Firebase
onAuthStateChanged(auth, (user) => {
    checkUserStatus(user);
});

// Listener para o botão de nova sessão (disponível após o check-up diário)
newSessionBtn.onclick = startNewSession;

// Resetar o timer de inatividade em interações-chave
document.addEventListener('mousemove', resetInactivityTimer);
document.addEventListener('keypress', resetInactivityTimer);
// Garantir que a tela de login é a primeira a aparecer antes da verificação de status
window.onload = () => {
    if (!currentUser) {
        loginScreen.classList.remove('hidden');
    }
};
</script>
</body>
</html>
