<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projeto de Mestrado - Mal√°ria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f9;
        }
        .chat-container {
            max-width: 700px;
        }
        .gemini-message {
            background-color: #e2e8f0;
            border-radius: 1.25rem 1.25rem 1.25rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            color: #1a202c;
        }
        .user-message {
            background-color: #5a67d8;
            border-radius: 1.25rem 1.25rem 0 1.25rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            color: #ffffff;
        }
        .loading-dots span {
            animation: bounce 0.6s infinite alternate;
        }
        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen">

    <div id="login-screen" class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg text-center transition-opacity duration-500 ease-in-out opacity-100">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Bem-vindo(a) ao Projeto de Mestrado referente ao Monitoramento da Mal√°ria na cidade de Porto Velho/RO</h1>
        <p class="text-gray-600 mb-8">Para acessar o sistema, realize o login com sua conta Google!</p>
        <button id="google-signin-btn" class="w-full flex items-center justify-center bg-indigo-600 text-white font-medium py-3 px-6 rounded-xl hover:bg-indigo-700 transition-colors duration-200">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                <path d="M22.062 12.001c0-.776-.07-1.524-.199-2.247h-9.863v4.22h5.532c-.237 1.266-1.112 2.348-2.617 3.238v2.793h3.582c2.094-1.928 3.32-4.757 3.32-8.004z" fill="#4285F4"/>
                <path d="M12.001 22.062c3.27 0 6.012-1.077 8.01-2.92l-3.582-2.793c-1.011.681-2.298 1.139-4.428 1.139-3.411 0-6.307-2.294-7.351-5.385h-3.69v2.859c2.071 4.102 6.551 6.899 11.041 6.899z" fill="#34A853"/>
                <path d="M4.65 14.397c-.244-.68-.38-1.408-.38-2.196s.136-1.516.38-2.196v-2.859h-3.69c-.663 1.34-.997 2.822-.997 4.055 0 1.233.334 2.715.997 4.055l3.69-2.859z" fill="#FBBC05"/>
                <path d="M12.001 4.397c2.199 0 4.093.757 5.613 2.113l3.058-3.058c-2.19-2.072-5.084-3.352-8.671-3.352-4.49 0-8.97 2.797-11.041 6.899l3.69 2.859c1.044-3.091 3.94-5.385 7.351-5.385z" fill="#EA4335"/>
            </svg>
            Entrar com Google
        </button>
    </div>

    <div id="chat-screen" class="hidden flex flex-col items-center w-full min-h-screen transition-opacity duration-500 ease-in-out opacity-0 relative">
    
        <h1 class="text-2xl font-bold text-indigo-700 mb-2 text-center mt-6">
            Projeto de Mestrado - Monitoramento da Mal√°ria em Porto Velho
        </h1>
        <h2 id="user-name" class="text-xl font-semibold text-gray-800 mb-4 text-center"></h2>
        
        <div class="chat-container w-full mx-auto flex flex-col p-4 overflow-y-auto h-[calc(100vh-220px)] pb-16">
        </div>

        <div id="loading-indicator" class="hidden my-4">
            <span class="loading-dots inline-flex space-x-1">
                <span class="block w-2 h-2 bg-indigo-600 rounded-full"></span>
                <span class="block w-2 h-2 bg-indigo-600 rounded-full"></span>
                <span class="block w-2 h-2 bg-indigo-600 rounded-full"></span>
            </span>
        </div>
        
        <div class="fixed bottom-0 w-full md:w-6/12 p-4 bg-white rounded-t-2xl shadow-lg flex items-center">
            <input id="message-input" type="text" placeholder="Escreva uma mensagem..." class="flex-grow bg-gray-100 py-3 px-4 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="send-btn" class="ml-4 p-3 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </button>
        </div>

        <div id="new-session-container" class="mt-4 hidden w-full md:w-5/12 p-4">
            <button id="new-session-btn" class="w-full bg-green-500 text-white font-medium py-3 px-6 rounded-xl hover:bg-green-600 transition-colors duration-200">
                Come√ßar Nova Sess√£o ‚ú®
            </button>
        </div>
        <div id="reminder-container" class="mt-2 hidden w-full md:w-5/12 p-4 text-center">
            <button id="enable-reminders-btn" class="w-full bg-blue-500 text-white font-medium py-2 px-4 rounded-xl hover:bg-blue-600 transition-colors duration-200">
                Ativar Lembretes Di√°rios üîî
            </button>
            <p id="reminder-status" class="mt-2 text-sm text-gray-500 hidden"></p>
        </div>
    </div>
    
    <div id="form-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-10 mx-auto p-5 border w-96 shadow-lg rounded-2xl bg-white max-h-[90vh]">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Antes de come√ßar a responder ao question√°rio, precisamos coletar alguns dados que ser√£o necess√°rios para o desenvolvimento do projeto.</h3>
                <p class="text-sm text-gray-500 mt-2">Por favor, preencha todos os campos abaixo!</p>
                <form id="health-form" class="mt-4 space-y-4 text-left overflow-y-auto max-h-[60vh] p-2">
                    <div>
                        <label for="rg" class="block text-sm font-medium text-gray-700">RG</label>
                        <input type="text" id="rg" class="p-1 bg-gray-50 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 uppercase">
                    </div>
                    <div>
                        <label for="cpf" class="block text-sm font-medium text-gray-700">CPF</label>
                        <input type="text" id="cpf" class="p-1 bg-gray-50 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 uppercase">
                    </div>
                    <div>
                        <label for="endereco" class="block text-sm font-medium text-gray-700">Endere√ßo Completo</label>
                        <input type="text" id="endereco" class="p-1 bg-gray-50 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 uppercase">
                    </div>
                    <div>
                        <label for="cidade" class="block text-sm font-medium text-gray-700">Cidade</label>
                        <input type="text" id="cidade" class="p-1 bg-gray-50 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 uppercase">
                    </div>
                    <div>
                        <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
                        <input type="text" id="estado" class="p-1 bg-gray-50 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 uppercase">
                    </div>
                    <h4 class="text-base text-center font-semibold text-gray-800 mt-6 pt-4 border-t">Hist√≥rico de Sa√∫de</h4>
                    <div>
                        <label for="tipoMalaria" class="block text-sm font-medium text-gray-700">Tipo de Mal√°ria</label>
                        <input type="text" id="tipoMalaria" class="p-1 bg-gray-50 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 uppercase">
                    </div>
                    <div>
                        <label for="inicioSintomas" class="block text-sm font-medium text-gray-700">In√≠cio dos Sintomas</label>
                        <input type="date" id="inicioSintomas" class="p-1 bg-gray-50 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="dataAtendimento" class="block text-sm font-medium text-gray-700">Data do Atendimento</label>
                        <input type="date" id="dataAtendimento" class="p-1 bg-gray-50 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="unidadeAtendimento" class="block text-sm font-medium text-gray-700">Unidade de Atendimento</label>
                        <input type="text" id="unidadeAtendimento" class="p-1 bg-gray-50 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 uppercase">
                    </div>
                    <div class="flex items-center">
                        <input id="medicacaoDistribuida" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="medicacaoDistribuida" class="ml-2 block text-sm text-gray-900">Foi distribu√≠da a Tafenoquina?</label>
                    </div>
                    <div class="flex items-center">
                        <input id="teveFebre" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="teveFebre" class="ml-2 block text-sm text-gray-900">Teve febre?</label>
                    </div>
                    <div class="flex items-center">
                        <input id="hipertenso" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="hipertenso" class="ml-2 block text-sm text-gray-900">√â hipertenso?</label>
                    </div>
                    <div class="flex items-center">
                        <input id="diabetes" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="diabetes" class="ml-2 block text-sm text-gray-900">Tem diabetes?</label>
                    </div>
                </form>
                <div class="items-center px-4 py-3">
                    <button id="save-form-btn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-xl w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        Salvar e Continuar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="tcle-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/5 xl:w-2/5 shadow-lg rounded-2xl bg-white max-h-[90vh]">
            <div class="mt-3 text-center flex flex-col h-full">
                <h3 class="text-xl leading-6 font-bold text-gray-900 mb-4">Termo de Consentimento Livre e Esclarecido (TCLE)</h3>
                
                <div class="flex-grow overflow-y-auto p-4 border rounded-lg bg-gray-50 text-left text-sm text-gray-700 max-h-[60vh]">
                    <p class="font-semibold mb-2">Prezado(a) Participante,</p>
                    <p class="mb-3">Voc√™ est√° sendo convidado(a) a participar do **Projeto de Mestrado - Monitoramento da Mal√°ria em Porto Velho**, desenvolvido no √¢mbito do seu Programa de P√≥s-Gradua√ß√£o.</p>

                    <h4 class="font-bold mt-4 mb-1">Objetivo do Estudo:</h4>
                    <p class="mb-3">O objetivo principal deste estudo √© realizar o monitoramento di√°rio da sua condi√ß√£o de sa√∫de ap√≥s o tratamento da mal√°ria, coletando dados essenciais para melhorar as estrat√©gias de vigil√¢ncia e combate √† doen√ßa em Porto Velho/RO. Os dados fornecidos ser√£o estritamente confidenciais e utilizados apenas para fins de pesquisa e desenvolvimento de pol√≠ticas p√∫blicas de sa√∫de.</p>
                    
                    <h4 class="font-bold mt-4 mb-1">Riscos e Benef√≠cios:</h4>
                    <p class="mb-3">N√£o h√° riscos diretos associados √† sua participa√ß√£o. Os benef√≠cios incluem o acompanhamento cont√≠nuo da sua sa√∫de e a contribui√ß√£o para um projeto cient√≠fico de grande relev√¢ncia social.</p>

                    <h4 class="font-bold mt-4 mb-1">Confidencialidade:</h4>
                    <p class="mb-3">Seus dados pessoais e de sa√∫de ser√£o tratados com a mais absoluta **confidencialidade**, sendo armazenados em um ambiente seguro (Firebase) e acess√≠veis apenas pela equipe de pesquisa.</p>
                    
                    <h4 class="font-bold mt-4 mb-1 text-red-600">Direito de Retirada:</h4>
                    <p class="mb-3 font-semibold text-red-600">**Sua participa√ß√£o neste estudo √© volunt√°ria e n√£o remunerada. Voc√™ tem o direito de recusar-se a participar ou de retirar o seu consentimento e interromper sua participa√ß√£o a qualquer momento, sem qualquer preju√≠zo √† sua assist√™ncia ou tratamento.**</p>
                    
                    <p class="mt-4">Ao marcar a caixa abaixo e clicar em "Desejo Participar", voc√™ declara que leu e entendeu os termos deste consentimento e concorda em participar voluntariamente do estudo.</p>
                </div>
                <div class="mt-4 flex flex-col space-y-3">
                    <div class="flex items-center justify-center">
                        <input id="tcle-consent-checkbox" type="checkbox" class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="tcle-consent-checkbox" class="ml-3 block text-base font-medium text-gray-900">
                            **Consentindo** com os termos acima.
                        </label>
                    </div>
                    <button id="tcle-participar-btn" disabled class="px-4 py-3 bg-gray-400 text-white text-base font-medium rounded-xl w-full shadow-sm cursor-not-allowed">
                        Desejo Participar
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="error-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-2xl bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Erro</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="error-message" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-error-modal" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-xl w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, getDocs, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// Variaveis de configuracao do seu projeto, essas variaveis sao privadas, nunca as exponha.
const firebaseConfig = {
    apiKey: "AIzaSyCEW-C1FavyFqjabMjmS-JVo2fLXHNt5Yg",
    authDomain: "meuaplicativosaude.firebaseapp.com",
    projectId: "meuaplicativosaude",
    storageBucket: "meuaplicativosaude.firebasestorage.app",
    messagingSenderId: "547845597696",
    appId: "1:547845597696:web:7942056f2d48601fa086e5",
    measurementId: "G-MYE47X3LNH"
};

// Chave de API do Gemini, nunca a exponha.
const geminiApiKey = "AIzaSyBeLGZcfbhn9lYFzsy6YWDI8PNquvZ9aE0";

// Inicializar Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Vari√°vel para armazenar o estado do usu√°rio
let currentUser = null;

// Elementos do DOM
const loginScreen = document.getElementById('login-screen');
const chatScreen = document.getElementById('chat-screen');
const googleSigninBtn = document.getElementById('google-signin-btn');
const chatContainer = document.querySelector('.chat-container');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const loadingIndicator = document.getElementById('loading-indicator');
const errorModal = document.getElementById('error-modal');
const errorMessageElem = document.getElementById('error-message');
const closeErrorModalBtn = document.getElementById('close-error-modal');
const newSessionBtn = document.getElementById('new-session-btn');
const newSessionContainer = document.getElementById('new-session-container');
const reminderContainer = document.getElementById('reminder-container');
const enableRemindersBtn = document.getElementById('enable-reminders-btn');
const formModal = document.getElementById('form-modal');
const saveFormBtn = document.getElementById('save-form-btn');
const userNameElem = document.getElementById('user-name');
// NOVAS VARI√ÅVEIS PARA O TCLE
const tcleModal = document.getElementById('tcle-modal');
const tcleConsentCheckbox = document.getElementById('tcle-consent-checkbox');
const tcleParticiparBtn = document.getElementById('tcle-participar-btn');

// Perguntas aprimoradas
let dailyQuestions = [
    "1. Como voc√™ est√° se sentindo hoje? (Responda: Em uma escala de 1 a 5, sendo 1-Ruim e 5-Excelente)",
    "2. Voc√™ faz uso de alguma medica√ß√£o de uso cont√≠nuo? (Responda: Informe o nome da medica√ß√£o ou N√£o)",
    "3. Voc√™ apresentou sinais de febre, v√¥mito, diarr√©ia, cefel√©ia ou algum outro sintoma?",
    "4. Fez uso de alguma medica√ß√£o que n√£o seja a Tafenoquina indicada para o tratamento da mal√°ria e que n√£o seja a de uso cont√≠nuo? (Informe o nome ou N√£o)",
    "5. Teve necessidade de procurar ajuda em alguma Unidade B√°sica de Sa√∫de?",
];

// Vari√°vel para rastrear o estado da conversa e dados do usu√°rio
let conversationStep = 0;
let userResponses = {};
let isWaitingForSummary = false;
let userProfileData = null;

// VARI√ÅVEIS PARA O TEMPORIZADOR DE INATIVIDADE
let inactivityTimer;
const INACTIVITY_TIMEOUT = 5 * 60 * 1000; // 5 minutos em milissegundos
let isSessionActive = false; // Come√ßa como inativa at√© o login e in√≠cio do question√°rio

// Fun√ß√£o para mostrar o modal de erro
function showError(message) {
    errorMessageElem.textContent = message;
    errorModal.classList.remove('hidden');
}

closeErrorModalBtn.onclick = () => {
    errorModal.classList.add('hidden');
};

// Fun√ß√£o para rolar para o final do chat
function scrollToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// üí• FUN√á√ÉO CORRIGIDA: Usa toLocaleDateString e toLocaleTimeString separadamente para garantir a exibi√ß√£o completa
function formatTimestamp(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate();
    
    // Op√ß√µes de Data
    const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };
    // Op√ß√µes de Hora
    const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };

    const formattedDate = date.toLocaleDateString('pt-BR', dateOptions);
    const formattedTime = date.toLocaleTimeString('pt-BR', timeOptions);

    // Concatena explicitamente a data e a hora
    return `${formattedDate} ${formattedTime}`;
}

// Fun√ß√£o para formatar a data apenas
function getFormattedDate() {
    const today = new Date();
    const options = {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    };
    return today.toLocaleDateString('pt-BR', options);
}

// üí• FUN√á√ÉO CORRIGIDA: Utiliza a nova l√≥gica de formata√ß√£o de fallback
function displayMessage(message, isUser, timestamp) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `my-2 p-2 rounded max-w-sm whitespace-pre-wrap ${isUser ? 'user-message self-end' : 'gemini-message self-start'}`;

    const textNode = document.createElement('p');
    textNode.textContent = message;
    messageDiv.appendChild(textNode);

    const timestampNode = document.createElement('span');
    timestampNode.className = `text-xs mt-1 block ${isUser ? 'text-gray-400' : 'text-gray-500'}`;
    
    // L√≥gica para o fallback de timestamp, garantindo data e hora
    const dateOptionsFallback = { year: 'numeric', month: '2-digit', day: '2-digit' };
    const timeOptionsFallback = { hour: '2-digit', minute: '2-digit', hour12: false };
    const now = new Date();

    const fallbackDisplay = `${now.toLocaleDateString('pt-BR', dateOptionsFallback)} ${now.toLocaleTimeString('pt-BR', timeOptionsFallback)}`;

    // Chama formatTimestamp para mensagens do DB ou usa o fallback expl√≠cito
    timestampNode.textContent = timestamp 
        ? formatTimestamp(timestamp) 
        : fallbackDisplay; 

    messageDiv.appendChild(timestampNode);

    chatContainer.appendChild(messageDiv);
    scrollToBottom();
}

// FUN√á√ïES DO TEMPORIZADOR
function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    if (currentUser && isSessionActive) {
        inactivityTimer = setTimeout(endSession, INACTIVITY_TIMEOUT);
    }
}

async function endSession() {
    if (!currentUser || !isSessionActive) return;

    isSessionActive = false;
    messageInput.disabled = true;
    sendBtn.disabled = true;

    const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/chat_messages`);
    const endMessage = "Sess√£o encerrada por inatividade. Caso queira responder novamente para fins de acompanhamento da evolu√ß√£o cl√≠nica, registro di√°rio ou esclarecer d√∫vidas acerca do tratamento da Mal√°ria, atualize a p√°gina!";

    // O timestamp ser√° adicionado pela fun√ß√£o displayMessage
    await addDoc(chatCollectionRef, { text: endMessage, isUser: false, timestamp: serverTimestamp() });
    conversationStep = -1; // Estado que indica sess√£o encerrada
}

// Fun√ß√£o para gerar uma resposta do chatbot usando a API Gemini
async function getGeminiResponse(prompt) {
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;
    const payload = {
        contents: [{ parts: [{ text: prompt }] }],
    };

    let retries = 0;
    const maxRetries = 3;
    let success = false;
    let responseData;

    while (!success && retries < maxRetries) {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                throw new Error(`Erro HTTP! status: ${response.status}`);
            }
            responseData = await response.json();
            success = true;
        } catch (e) {
            console.error("Erro na chamada da API:", e);
            retries++;
            if (retries < maxRetries) {
                const delay = Math.pow(2, retries) * 1000;
                await new Promise(res => setTimeout(res, delay));
            } else {
                throw e;
            }
        }
    }
    if (!success) {
        throw new Error('Falha na conex√£o com a API ap√≥s v√°rias tentativas.');
    }
    const candidate = responseData.candidates?.[0];
    const text = candidate?.content?.parts?.[0]?.text;
    return text || "N√£o foi poss√≠vel gerar uma resposta. Tente novamente.";
}

// Fun√ß√£o para gerar uma resposta de reconhecimento com a API Gemini
async function getGeminiAcknowledgement(userResponse, question) {
    const prompt = `Gere uma pequena e amig√°vel resposta de reconhecimento, com cerca de 20 palavras, para a seguinte resposta do usu√°rio: "${userResponse}" √† pergunta: "${question}".`;
    return await getGeminiResponse(prompt);
}

// Fun√ß√£o para lidar com o envio de mensagens
async function sendMessage() {
    if (!currentUser) {
        showError("Voc√™ precisa estar logado para enviar mensagens.");
        return;
    }

    const message = messageInput.value.trim();
    if (message === '' || isWaitingForSummary) return;

    // L√≥gica para reiniciar o question√°rio ap√≥s inatividade
    if (conversationStep === -1) {
        messageInput.value = '';
        messageInput.disabled = true;
        sendBtn.disabled = true;
        loadingIndicator.classList.remove('hidden');

        // Adiciona a mensagem do usu√°rio antes de reiniciar
        const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/chat_messages`);
        await addDoc(chatCollectionRef, { text: message, isUser: true, timestamp: serverTimestamp() });
        
        await startNewSession(); // Reinicia o question√°rio (apaga o chat e come√ßa do 0)
        loadingIndicator.classList.add('hidden');
        resetInactivityTimer();
        return; 
    }

    resetInactivityTimer(); // Reseta o timer a cada intera√ß√£o

    messageInput.value = '';
    loadingIndicator.classList.remove('hidden');

    try {
        const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/chat_messages`);
        await addDoc(chatCollectionRef, { text: message, isUser: true, timestamp: serverTimestamp() });

        // L√≥gica para responder a perguntas sobre mal√°ria
        const malariaKeywords = ["mal√°ria", "malaria", "sintomas", "tratamento", "diagn√≥stico", "preven√ß√£o", "d√∫vida"];
        // Verifica se √© uma pergunta sobre mal√°ria E se o question√°rio j√° foi conclu√≠do
        const isMalariaQuestion = conversationStep >= dailyQuestions.length && malariaKeywords.some(keyword => message.toLowerCase().includes(keyword));

        if (isMalariaQuestion) {
            const prompt = `Com base nas informa√ß√µes do Minist√©rio da Sa√∫de sobre mal√°ria em https://www.gov.br/saude/pt-br/assuntos/saude-de-a-a-z/m/malaria, gere uma resposta detalhada e amig√°vel sobre a pergunta: "${message}".`;
            const botResponse = await getGeminiResponse(prompt);
            await addDoc(chatCollectionRef, { text: botResponse, isUser: false, timestamp: serverTimestamp() });
        } else if (conversationStep < dailyQuestions.length) {
            userResponses[conversationStep] = message;

            let botResponseText = '';
            if (conversationStep === 0) {
                const sentiment = parseInt(message);
                if (sentiment < 3) {
                    botResponseText = "Entendido. Acompanharemos de perto sua evolu√ß√£o cl√≠nica.";
                } else {
                    botResponseText = "Que bom! Ficamos felizes em saber que seu estado cl√≠nico est√° bem .";
                }
            } else if (conversationStep === 3) {
                const hasSymptoms = message.toLowerCase().includes("sim");
                if (hasSymptoms) {
                    botResponseText = "√â muito importante monitorar esses sintomas. Continuamos no monitoramento.";
                } else {
                    botResponseText = "Excelente! Continuamos no monitoramento.";
                }
            } else {
                botResponseText = await getGeminiAcknowledgement(message, dailyQuestions[conversationStep]);
            }

            await addDoc(chatCollectionRef, { text: botResponseText, isUser: false, timestamp: serverTimestamp() });

            conversationStep++;
            let nextQuestionText = dailyQuestions[conversationStep];

            if (userProfileData && (userProfileData.hipertenso || userProfileData.diabetes) && conversationStep === 1) {
                const hasDiabetes = userProfileData.diabetes;
                const hasHypertension = userProfileData.hipertenso;
                let comorbidade = '';

                if (hasHypertension && hasDiabetes) {
                    comorbidade = ' para hipertens√£o e diabetes';
                } else if (hasHypertension) {
                    comorbidade = ' para hipertens√£o';
                } else if (hasDiabetes) {
                    comorbidade = ' para diabetes';
                }

                nextQuestionText = `2. Voc√™ faz uso de alguma medica√ß√£o de uso cont√≠nuo${comorbidade}?`;
            }

            if (nextQuestionText) {
                await addDoc(chatCollectionRef, { text: nextQuestionText, isUser: false, timestamp: serverTimestamp() });
            } else {
                await generateSummary(currentUser);
            }
        } else {
            // Se o question√°rio j√° foi conclu√≠do (e n√£o √© uma pergunta de mal√°ria)
            const prompt = `Responda de forma amig√°vel e breve √† seguinte mensagem do usu√°rio, sem iniciar um novo question√°rio: "${message}".`;
            const botResponse = await getGeminiResponse(prompt);
            await addDoc(chatCollectionRef, { text: botResponse, isUser: false, timestamp: serverTimestamp() });
        }

    } catch (error) {
        console.error("Erro ao enviar mensagem ou obter resposta:", error);
        showError("N√£o foi poss√≠vel enviar a mensagem ou obter a resposta do chatbot. Tente novamente mais tarde.");
    } finally {
        loadingIndicator.classList.add('hidden');
    }
}

async function generateSummary(user) {
    isWaitingForSummary = true;
    messageInput.disabled = true;
    sendBtn.disabled = true;
    clearTimeout(inactivityTimer); // Pausa o timer enquanto gera o relat√≥rio

    const formattedDate = getFormattedDate();

    const summaryPrompt = `Gere um relat√≥rio detalhado com a seguinte estrutura e informa√ß√µes:
**Data:** ${formattedDate}
**Fonte das Informa√ß√µes:** Respostas a question√°rio de sa√∫de.
---
### **1. An√°lise das Respostas Individuais:**
${Object.keys(userResponses).map(key => `* **Pergunta ${parseInt(key) + 1}: ${dailyQuestions[key]} Resposta: ${userResponses[key]}**\n ¬† ¬† * **Avalia√ß√£o:** (Gere uma avalia√ß√£o curta para esta resposta)`).join('\n')}
---
### **2. Avalia√ß√£o Cl√≠nica Baseada em Expertise M√©dica:**
(Gere um par√°grafo que resume a situa√ß√£o cl√≠nica com base em todas as respostas.)
---
### **3. Sintomas Relatados e Avalia√ß√£o da Gravidade:**
(Gere um par√°grafo que liste os sintomas relatados ou a aus√™ncia deles e avalie a gravidade.)
---
### **4. Conduta do Paciente:**
(Gere um par√°grafo que descreva as a√ß√µes do paciente com base nas respostas.)
---
### **5. Conclus√£o e Recomenda√ß√µes:**
(Gere uma conclus√£o forte. Se os sintomas (como febre alta, v√¥mito, diarreia, calafrios) forem persistentes ou indicativos de gravidade, a conclus√£o deve ser uma forte recomenda√ß√£o para o paciente procurar a unidade de sa√∫de mais pr√≥xima, com urg√™ncia. Se os sintomas n√£o forem graves ou se o paciente estiver se sentindo bem, a conclus√£o deve indicar que n√£o √© necess√°rio procurar uma unidade de sa√∫de, mas sim continuar se hidratando e fazendo uso correto da medica√ß√£o, se aplic√°vel e indique se houve evolu√ß√£o clinica entre o monitoramento anterior e o atual, caso exista.)
---
### **6. Informe sobre o tratamento da mal√°ria:**
(Gere um par√°grafo que descreva o que √© a mal√°ria, seu tratamento e caso necessite falar a respeito do tratamento, do diagin√≥stico e do estado cl√≠nico apresentado, pode ser feito por aqui, basta formular a sua pergunta!)

`;

    const botResponse = await getGeminiResponse(summaryPrompt);

    const checkinRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/checkin_status/daily_status`);
    await setDoc(checkinRef, {
        lastCheckin: serverTimestamp(),
        summary: botResponse,
    });

    const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/chat_messages`);
    
    // Adiciona o relat√≥rio detalhado
    await addDoc(chatCollectionRef, {
        text: "‚ú® Relat√≥rio Detalhado:\n" + botResponse,
        isUser: false,
        timestamp: serverTimestamp(),
    });
    
    // Adiciona a pergunta de encerramento
    const finalQuestion = "Agradecemos sua participa√ß√£o! Espero que seu estado cl√≠nico evolua rapidamente e sua sa√∫de seja restabelecida. Estamos trabalhando fortemente para erradicar a Mal√°ria em Porto Velho e sua participa√ß√£o √© de fundamental import√¢ncia, conte conosco! Estaremos sempre √† disposi√ß√£o.";
    await addDoc(chatCollectionRef, {
        text: finalQuestion,
        isUser: false,
        timestamp: serverTimestamp(),
    });

    isWaitingForSummary = false;
    messageInput.disabled = false;
    sendBtn.disabled = false;
    newSessionContainer.classList.remove('hidden');
    conversationStep = dailyQuestions.length; // Indica que o question√°rio foi conclu√≠do
    resetInactivityTimer(); // Inicia o timer de inatividade de 5 minutos
}

async function startNewSession() {
    if (!currentUser) {
        showError("Voc√™ precisa estar logado para iniciar uma nova sess√£o.");
        return;
    }
    loadingIndicator.classList.remove('hidden');
    try {
        const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/chat_messages`);
        const docsToDelete = await getDocs(chatCollectionRef);
        const deletePromises = docsToDelete.docs.map(docToDelete => deleteDoc(doc(db, chatCollectionRef.path, docToDelete.id)));
        await Promise.all(deletePromises);
        await startInitialConversation(currentUser);
        newSessionContainer.classList.add('hidden');
    } catch (error) {
        console.error("Erro ao iniciar nova sess√£o:", error);
        showError("N√£o foi poss√≠vel iniciar uma nova sess√£o. Tente novamente mais tarde.");
    } finally {
        loadingIndicator.classList.add('hidden');
    }
}

async function startInitialConversation(user) {
    const userProfileRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}`);
    const userProfileSnap = await getDoc(userProfileRef);
    const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/chat_messages`);

    chatContainer.innerHTML = '';
    conversationStep = 0;
    userResponses = {};
    isSessionActive = true; // Ativa a sess√£o
    resetInactivityTimer(); // Inicia o timer

    if (!userProfileSnap.exists()) {
        // Usu√°rio novo: Exibe o formul√°rio de cadastro
        formModal.classList.remove('hidden');
        messageInput.disabled = true;
        sendBtn.disabled = true;
        isSessionActive = false;
    } else {
        userProfileData = userProfileSnap.data();

        // Verifica se j√° deu o consentimento
        if (!userProfileData.consentido) {
            // Usu√°rio cadastrado mas sem consentimento: Exibe o TCLE
            tcleModal.classList.remove('hidden');
            messageInput.disabled = true;
            sendBtn.disabled = true;
            isSessionActive = false;
            return; // Para o fluxo aqui e espera o consentimento
        }

        // Usu√°rio cadastrado E consentiu: Inicia o chat
        const checkinRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/checkin_status/daily_status`);
        const checkinSnap = await getDoc(checkinRef);

        messageInput.disabled = false;
        sendBtn.disabled = false;

        if (checkinSnap.exists()) {
            const lastSummary = checkinSnap.data().summary;
            const summaryMessage = `Ol√°, ${user.displayName}! üëã Que bom te ver de volta. Aqui est√° um resumo da sua √∫ltima consulta: \n\n${lastSummary}`;
            await addDoc(chatCollectionRef, { text: summaryMessage, isUser: false, timestamp: serverTimestamp() });
            await addDoc(chatCollectionRef, { text: dailyQuestions[0], isUser: false, timestamp: serverTimestamp() });
        } else {
            const welcomeMessage = `Ol√°, ${user.displayName}! üëã Que bom te ver de volta. Vamos come√ßar o seu primeiro check-in di√°rio.`;
            await addDoc(chatCollectionRef, { text: welcomeMessage, isUser: false, timestamp: serverTimestamp() });
            await addDoc(chatCollectionRef, { text: dailyQuestions[0], isUser: false, timestamp: serverTimestamp() });
        }
    }
}

async function handleFormSubmission() {
    if (!currentUser) {
        showError("Erro: Usu√°rio n√£o autenticado.");
        return;
    }

    // Valida√ß√£o b√°sica
    const requiredFields = ['rg', 'cpf', 'endereco', 'cidade', 'estado', 'tipoMalaria', 'inicioSintomas', 'dataAtendimento', 'unidadeAtendimento'];
    const isFormValid = requiredFields.every(id => document.getElementById(id).value.trim() !== '');

    if (!isFormValid) {
        showError("Por favor, preencha todos os campos do formul√°rio para continuar.");
        return;
    }

    const formData = {
        rg: document.getElementById('rg').value,
        cpf: document.getElementById('cpf').value,
        endereco: document.getElementById('endereco').value,
        cidade: document.getElementById('cidade').value,
        estado: document.getElementById('estado').value,
        tipoMalaria: document.getElementById('tipoMalaria').value,
        inicioSintomas: document.getElementById('inicioSintomas').value,
        dataAtendimento: document.getElementById('dataAtendimento').value,
        unidadeAtendimento: document.getElementById('unidadeAtendimento').value,
        medicacaoDistribuida: document.getElementById('medicacaoDistribuida').checked,
        teveFebre: document.getElementById('teveFebre').checked,
        hipertenso: document.getElementById('hipertenso').checked,
        diabetes: document.getElementById('diabetes').checked,
        consentido: false // Inicializa como N√ÉO consentido
    };

    try {
        const userProfileRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}`);
        await setDoc(userProfileRef, {
            uid: currentUser.uid,
            email: currentUser.email,
            displayName: currentUser.displayName,
            createdAt: serverTimestamp(),
            ...formData
        });
        formModal.classList.add('hidden');

        // Ap√≥s salvar o formul√°rio, exibe o modal do TCLE
        tcleModal.classList.remove('hidden');

        // Atualiza os dados do perfil localmente
        const userProfileSnap = await getDoc(userProfileRef);
        userProfileData = userProfileSnap.data();

    } catch (error) {
        console.error("Erro ao salvar dados do formul√°rio:", error);
        showError("N√£o foi poss√≠vel salvar seus dados. Tente novamente.");
    }
}

// L√≥gica do Modal de Termo de Consentimento (TCLE)
tcleConsentCheckbox.addEventListener('change', () => {
    if (tcleConsentCheckbox.checked) {
        tcleParticiparBtn.disabled = false;
        tcleParticiparBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
        tcleParticiparBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'focus:ring-indigo-500');
    } else {
        tcleParticiparBtn.disabled = true;
        tcleParticiparBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
        tcleParticiparBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'focus:ring-indigo-500');
    }
});

tcleParticiparBtn.addEventListener('click', async () => {
    if (!tcleConsentCheckbox.checked) {
        showError("Voc√™ deve concordar com o Termo de Consentimento para participar.");
        return;
    }

    try {
        // Salva o status de consentimento no perfil do usu√°rio
        const userProfileRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}`);
        await setDoc(userProfileRef, { consentido: true, consentimentoTimestamp: serverTimestamp() }, { merge: true });

        tcleModal.classList.add('hidden');

        // FINALIZA A INICIALIZA√á√ÉO e inicia o question√°rio
        await startInitialConversation(currentUser);

    } catch (error) {
        console.error("Erro ao registrar consentimento:", error);
        showError("N√£o foi poss√≠vel registrar seu consentimento. Tente novamente.");
    }
});

// Fun√ß√µes de Autentica√ß√£o e Listener
googleSigninBtn.onclick = async () => {
    const provider = new GoogleAuthProvider();
    try {
        await signInWithPopup(auth, provider);
    } catch (error) {
        console.error("Erro no login com Google:", error);
        showError("Falha ao entrar com Google. Tente novamente.");
    }
};

onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = user;
        userNameElem.textContent = `Ol√°, ${user.displayName || user.email}!`;
        loginScreen.classList.add('opacity-0', 'pointer-events-none');
        setTimeout(() => {
            loginScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');
            chatScreen.classList.add('opacity-100');
            startInitialConversation(user);
            listenForMessages(user);
        }, 500);
    } else {
        currentUser = null;
        chatScreen.classList.remove('opacity-100');
        chatScreen.classList.add('opacity-0');
        loginScreen.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
        messageInput.disabled = true;
        sendBtn.disabled = true;
        isSessionActive = false;
        clearTimeout(inactivityTimer);
    }
});

// Fun√ß√£o para ouvir mensagens do chat em tempo real
function listenForMessages(user) {
    if (!user) return;
    const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/chat_messages`);
    const q = query(chatCollectionRef, orderBy("timestamp", "asc"));

    onSnapshot(q, (snapshot) => {
        // Reinicia o timer em qualquer atividade do chat (inclusive as do bot)
        resetInactivityTimer();
        
        const isInitialLoad = chatContainer.children.length === 0;

        snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
                const data = change.doc.data();
                displayMessage(data.text, data.isUser, data.timestamp);
                
                // L√≥gica de atualiza√ß√£o do conversationStep na carga inicial ou em mensagens do bot
                if (isInitialLoad && !data.isUser && dailyQuestions.includes(data.text.split('\n')[0])) {
                    conversationStep = dailyQuestions.findIndex(q => q === data.text.split('\n')[0]);
                }
            }
        });
    });
}

// Event listener para o bot√£o Salvar do formul√°rio
saveFormBtn.addEventListener('click', handleFormSubmission);

// Event listener para o bot√£o de Envio (Send)
sendBtn.addEventListener('click', sendMessage);

// Event listener para o Enter no input
messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
    }
});

// Event listener para o bot√£o Nova Sess√£o
newSessionBtn.addEventListener('click', startNewSession);
</script>
</body>
</html>