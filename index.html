<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento de Mal√°ria - Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* Ajuste crucial: removemos a altura fixa (80vh) e confiamos no flex-grow */
        .chat-container {
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }
        .user-message {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            border-top-right-radius: 1rem;
            border-bottom-left-radius: 1rem;
            border-top-left-radius: 1rem;
            margin-left: auto; /* Alinha √† direita */
        }
        .gemini-message {
            background-color: #eef2ff; /* Indigo-50 */
            color: #1e293b; /* Slate-800 */
            border-top-left-radius: 1rem;
            border-bottom-right-radius: 1rem;
            border-top-right-radius: 1rem;
            margin-right: auto; /* Alinha √† esquerda */
        }
        .chat-container > div {
            max-width: 80%;
        }
        /* Estilos do Scrollbar Customizado para o formul√°rio */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c3c3c3;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Tela de Login -->
    <div id="login-screen" class="flex flex-col items-center justify-center p-8 bg-white shadow-2xl rounded-2xl w-full max-w-md transition-all duration-500">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-indigo-600 mb-4" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 12h-2v-4h-2V7h4v5h2z" />
        </svg>
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">Monitoramento da Mal√°ria em Porto Velho</h1>
        <p class="text-gray-600 mb-6 text-center">Entre para iniciar seu check-in di√°rio e receber monitoramento personalizado.</p>
        <button id="google-signin-btn" class="flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 shadow-md focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 48 48" fill="currentColor">
                <path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.692-5.743 7.917-10.303 7.917-6.903 0-12.498-5.592-12.498-12.496s5.595-12.496 12.498-12.496c3.243 0 6.208 1.157 8.524 3.037l-4.243 3.491c-1.353-.98-3.044-1.579-4.281-1.579-4.881 0-8.86 3.988-8.86 8.873s3.979 8.873 8.86 8.873c5.32 0 8.544-4.438 8.95-6.736h-8.95v-6.004z"/>
                <path fill="#FF3D00" d="M6.306 14.693l-4.405 3.486c-.991 1.932-1.501 3.992-1.501 6.321s.51 4.389 1.501 6.321l4.405 3.486c.942-2.228 1.487-4.498 1.487-7.238s-.545-5.01-1.487-7.238z"/>
                <path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.4-5.195l-5.694-4.493c-2.091 1.585-4.707 2.488-7.706 2.488-5.32 0-9.858-3.342-11.666-8.23l-5.378 4.227c2.618 6.275 9.421 10.708 16.944 10.708z"/>
                <path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.692-5.743 7.917-10.303 7.917-6.903 0-12.498-5.592-12.498-12.496s5.595-12.496 12.498-12.496c3.243 0 6.208 1.157 8.524 3.037l-4.243 3.491c-1.353-.98-3.044-1.579-4.281-1.579-4.881 0-8.86 3.988-8.86 8.873s3.979 8.873 8.86 8.873c5.32 0 8.544-4.438 8.95-6.736h-8.95v-6.004z"/>
            </svg>
            Entrar com Google
        </button>
    </div>

    <!-- Tela do Chat - Altura ajustada para 95% da tela e responsividade de bordas -->
    <div id="chat-screen" class="hidden flex flex-col w-full max-w-2xl bg-white shadow-2xl rounded-none md:rounded-2xl h-[95vh] transition-opacity duration-500 opacity-0">
        <!-- Cabe√ßalho do Chat - CENTRALIZADO -->
        <header class="p-4 bg-indigo-600 text-white rounded-t-none md:rounded-t-2xl shadow-md flex flex-col justify-center items-center">
            <!-- T√≠tulo Centralizado -->
            <h2 class="text-xl font-bold">Monitoramento de Mal√°ria PVH</h2>
            <!-- Nome do Usu√°rio na Resposta/Abaixo do T√≠tulo -->
            <span id="user-name" class="text-sm font-light opacity-80 mt-1"></span>
        </header>

        <!-- Container de Mensagens - Usa flex-grow para ocupar o espa√ßo restante -->
        <div class="chat-container flex-grow overflow-y-auto" id="chat-container">
            <!-- Mensagens ser√£o injetadas aqui -->
        </div>

        <!-- Indicador de Carregamento e Nova Sess√£o -->
        <div class="p-4 border-t border-gray-200">
            <div id="loading-indicator" class="hidden text-center text-indigo-500 font-medium my-2">
                <svg class="animate-spin h-5 w-5 text-indigo-500 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Gerando resposta...
            </div>
            
            <div id="new-session-container" class="hidden text-center my-2">
                <button id="new-session-btn" class="px-4 py-2 bg-green-500 text-white font-medium rounded-lg hover:bg-green-600 transition duration-150 shadow-md">
                    Iniciar Novo Check-in Di√°rio
                </button>
            </div>

            <!-- Input de Mensagem -->
            <div class="flex space-x-3">
                <input type="text" id="message-input" placeholder="Digite sua resposta ou uma d√∫vida sobre mal√°ria..." class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 shadow-inner" disabled>
                <button id="send-btn" class="flex-shrink-0 bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-xl transition duration-150 shadow-md focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Erro -->
    <div id="error-modal" class="hidden fixed inset-0 bg-red-900 bg-opacity-75 z-50 overflow-y-auto flex items-center justify-center">
        <div class="relative w-full max-w-sm mx-4 p-6 bg-white rounded-xl shadow-2xl">
            <div class="text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-red-600 mx-auto" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2h2a1 1 0 000-2H9zm-2 4h6v2H7v-2z" clip-rule="evenodd" />
                </svg>
                <h3 class="text-lg leading-6 font-medium text-red-900 mt-3">Erro de Aplica√ß√£o</h3>
                <p id="error-message" class="text-sm text-gray-500 mt-2">Ocorreu um erro desconhecido.</p>
            </div>
            <div class="mt-4">
                <button id="close-error-modal" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-lg w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal do TCLE (Termo de Consentimento Livre e Esclarecido) -->
    <div id="tcle-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 overflow-y-auto flex items-center justify-center">
        <div class="relative w-full max-w-xl mx-4 my-8 p-6 bg-white rounded-3xl shadow-2xl transform transition-all duration-300">
            <div class="text-center border-b pb-4 mb-4">
                <h3 class="text-2xl font-extrabold text-green-700 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    Termo de Consentimento
                </h3>
                <p class="text-sm text-gray-500 mt-2">Sua participa√ß√£o √© volunt√°ria e sigilosa.</p>
            </div>
            <div class="max-h-[60vh] overflow-y-auto p-4 border rounded-xl bg-gray-50 text-left text-sm text-gray-700 space-y-3 custom-scrollbar">
                <p>Eu, o participante, confirmo que li e entendi o Termo de Consentimento Livre e Esclarecido (TCLE) referente ao projeto de monitoramento de sa√∫de. Compreendo que meus dados de monitoramento e de sa√∫de (como RG, CPF e hist√≥rico de Mal√°ria) ser√£o utilizados exclusivamente para fins de pesquisa e acompanhamento epidemiol√≥gico, de forma anonimizada e sigilosa, pela equipe de sa√∫de de Porto Velho.</p>
                <p>Fui informado sobre o objetivo do estudo, os procedimentos envolvidos (preenchimento di√°rio de question√°rio via chatbot), os riscos m√≠nimos e os benef√≠cios potenciais (monitoramento da evolu√ß√£o cl√≠nica).</p>
                <p>Entendo que a minha participa√ß√£o √© totalmente **volunt√°ria**, e posso retirar meu consentimento a qualquer momento, sem que isso implique em qualquer preju√≠zo ao meu tratamento ou √† continuidade da minha assist√™ncia m√©dica.</p>
                <p>Ao marcar a caixa abaixo e clicar em "Participar", confirmo que concordo em participar do projeto.</p>
            </div>
            <div class="mt-4 pt-4 border-t">
                <div class="flex items-center mb-4">
                    <input id="tcle-consent-checkbox" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500">
                    <label for="tcle-consent-checkbox" class="ml-3 block text-base font-medium text-gray-900">Eu concordo com os termos acima.</label>
                </div>
                <button id="tcle-participar-btn" class="px-4 py-3 bg-gray-400 text-white text-base font-bold rounded-xl w-full shadow-md cursor-not-allowed" disabled>
                    Participar do Monitoramento
                </button>
            </div>
        </div>
    </div>

    <!-- Modal do Formul√°rio de Dados Iniciais (NOVO ESTILO) -->
    <div id="form-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 overflow-y-auto flex items-center justify-center">
        <div class="relative w-full max-w-xl mx-4 my-8 p-6 bg-white rounded-3xl shadow-2xl transform transition-all duration-300">
            <!-- HEADER -->
            <div class="text-center border-b pb-4 mb-4">
                <h3 class="text-2xl font-extrabold text-indigo-700 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-indigo-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9.5 9a1.5 1.5 0 000 3h1a1.5 1.5 0 000-3h-1z" clip-rule="evenodd" />
                    </svg>
                    Dados Essenciais para o Projeto
                </h3>
                <p class="text-sm text-gray-500 mt-2">Por favor, preencha as informa√ß√µes para iniciar seu monitoramento. Todos os campos s√£o necess√°rios.</p>
            </div>

            <!-- FORM CONTENT -->
            <form id="health-form" class="space-y-6 max-h-[70vh] overflow-y-auto pr-2 custom-scrollbar">

                <!-- Se√ß√£o 1: Dados Pessoais e Endere√ßo -->
                <div class="p-4 bg-indigo-50 rounded-xl shadow-inner border border-indigo-200">
                    <h4 class="text-lg font-bold text-indigo-800 mb-4">1. Identifica√ß√£o e Contato</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="rg" class="block text-xs font-semibold text-gray-700">RG</label>
                            <input type="text" id="rg" placeholder="Ex: 1234567-SSP/RO" class="mt-1 block w-full p-2.5 border border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        </div>
                        <div class="col-span-1">
                            <label for="cpf" class="block text-xs font-semibold text-gray-700">CPF</label>
                            <input type="text" id="cpf" placeholder="Ex: 000.000.000-00" class="mt-1 block w-full p-2.5 border border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        </div>
                    </div>

                    <div class="mt-4">
                        <label for="endereco" class="block text-xs font-semibold text-gray-700">Endere√ßo Completo</label>
                        <input type="text" id="endereco" placeholder="Rua, N√∫mero, Bairro" class="mt-1 block w-full p-2.5 border border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    </div>

                    <div class="grid grid-cols-3 gap-4 mt-4">
                        <div class="col-span-2">
                            <label for="cidade" class="block text-xs font-semibold text-gray-700">Cidade</label>
                            <input type="text" id="cidade" placeholder="Porto Velho" class="mt-1 block w-full p-2.5 border border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        </div>
                        <div class="col-span-1">
                            <label for="estado" class="block text-xs font-semibold text-gray-700">Estado</label>
                            <input type="text" id="estado" placeholder="RO" class="mt-1 block w-full p-2.5 border border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm uppercase">
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o 2: Informa√ß√µes Cl√≠nicas da Mal√°ria -->
                <div class="p-4 bg-yellow-50 rounded-xl shadow-inner border border-yellow-200">
                    <h4 class="text-lg font-bold text-yellow-800 mb-4">2. Dados do Diagn√≥stico e Tratamento</h4>

                    <!-- NOVO: Select para Tipo de Mal√°ria -->
                    <div>
                        <label for="tipoMalaria" class="block text-xs font-semibold text-gray-700">Tipo de Mal√°ria Diagn√≥stico</label>
                        <select id="tipoMalaria" class="mt-1 block w-full p-2.5 border border-yellow-300 rounded-lg shadow-sm focus:ring-yellow-500 focus:border-yellow-500 text-sm bg-white">
                            <option value="" disabled selected>Selecione o tipo de Mal√°ria</option>
                            <option value="P. vivax">P. vivax</option>
                            <option value="P. falciparum">P. falciparum</option>
                            <option value="Mista">Mista (P. vivax e P. falciparum)</option>
                            <option value="Outro/Desconhecido">Outro/Desconhecido</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label for="inicioSintomas" class="block text-xs font-semibold text-gray-700">Data de In√≠cio dos Sintomas</label>
                            <input type="date" id="inicioSintomas" class="mt-1 block w-full p-2.5 border border-yellow-300 rounded-lg shadow-sm focus:ring-yellow-500 focus:border-yellow-500 text-sm">
                        </div>
                        <div>
                            <label for="dataAtendimento" class="block text-xs font-semibold text-gray-700">Data do Primeiro Atendimento</label>
                            <input type="date" id="dataAtendimento" class="mt-1 block w-full p-2.5 border border-yellow-300 rounded-lg shadow-sm focus:ring-yellow-500 focus:border-yellow-500 text-sm">
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label for="unidadeAtendimento" class="block text-xs font-semibold text-gray-700">Unidade de Sa√∫de de Atendimento</label>
                        <input type="text" id="unidadeAtendimento" placeholder="Nome da UBS ou Centro de Sa√∫de" class="mt-1 block w-full p-2.5 border border-yellow-300 rounded-lg shadow-sm focus:ring-yellow-500 focus:border-yellow-500 text-sm">
                    </div>

                    <div class="mt-5 space-y-3">
                        <div class="flex items-center p-3 border border-yellow-300 rounded-lg bg-white shadow-sm">
                            <input id="medicacaoDistribuida" type="checkbox" class="h-4 w-4 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500">
                            <label for="medicacaoDistribuida" class="ml-3 block text-sm font-medium text-gray-900">A medica√ß√£o (incluindo Tafenoquina, se aplic√°vel) foi distribu√≠da?</label>
                        </div>
                        <div class="flex items-center p-3 border border-yellow-300 rounded-lg bg-white shadow-sm">
                            <input id="teveFebre" type="checkbox" class="h-4 w-4 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500">
                            <label for="teveFebre" class="ml-3 block text-sm font-medium text-gray-900">Voc√™ apresentou febre no dia do atendimento?</label>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o 3: Hist√≥rico de Comorbidades -->
                <div class="p-4 bg-red-50 rounded-xl shadow-inner border border-red-200">
                    <h4 class="text-lg font-bold text-red-800 mb-4">3. Comorbidades (Condi√ß√µes Cr√¥nicas)</h4>

                    <p class="text-sm text-gray-600 mb-4">Marque as condi√ß√µes de sa√∫de que voc√™ j√° possui. Essa informa√ß√£o √© importante para o monitoramento.</p>

                    <div class="space-y-3">
                        <div class="flex items-center p-3 border border-red-300 rounded-lg bg-white shadow-sm">
                            <input id="hipertenso" type="checkbox" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <label for="hipertenso" class="ml-3 block text-sm font-medium text-gray-900">Sou hipertenso(a) (press√£o alta).</label>
                        </div>
                        <div class="flex items-center p-3 border border-red-300 rounded-lg bg-white shadow-sm">
                            <input id="diabetes" type="checkbox" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <label for="diabetes" class="ml-3 block text-sm font-medium text-gray-900">Tenho diabetes (a√ß√∫car elevado no sangue).</label>
                        </div>
                    </div>
                </div>

                <!-- BOT√ÉO DE A√á√ÉO -->
                <div class="pt-4 sticky bottom-0 bg-white border-t -mx-6 px-6">
                    <button id="save-form-btn" type="button" class="px-4 py-3 bg-indigo-600 text-white text-base font-bold rounded-xl w-full shadow-lg hover:bg-indigo-700 transition duration-150 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.103A.89.89 0 0021 6.168v7.832a2 2 0 01-2 2H5a2 2 0 01-2-2V6.168c0-.68.397-1.3.882-1.615l4.404-2.202a1.2 1.2 0 011.096 0l4.404 2.202a.89.89 0 00.882 1.615z"/>
                        </svg>
                        Salvar Dados e Prosseguir para o Termo de Consentimento
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Script JavaScript -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, getDocs, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// Variaveis de configuracao do seu projeto, essas variaveis sao privadas, nunca as exponha.
const firebaseConfig = {
    apiKey: "AIzaSyCEW-C1FavyFqjabMjmS-JVo2fLXHNt5Yg",
    authDomain: "meuaplicativosaude.firebaseapp.com",
    projectId: "meuaplicativosaude",
    storageBucket: "meuaplicativosaude.firebasestorage.app",
    messagingSenderId: "547845597696",
    appId: "1:547845597696:web:7942056f2d48601fa086e5",
    measurementId: "G-MYE47X3LNH"
};

// Chave de API do Gemini, nunca a exponha.
const geminiApiKey = "AIzaSyBeLGZcfbhn9lYFzsy6YWDI8PNquvZ9aE0";

// Inicializar Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Vari√°vel para armazenar o estado do usu√°rio
let currentUser = null;

// Elementos do DOM
const loginScreen = document.getElementById('login-screen');
const chatScreen = document.getElementById('chat-screen');
const googleSigninBtn = document.getElementById('google-signin-btn');
const chatContainer = document.querySelector('.chat-container');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const loadingIndicator = document.getElementById('loading-indicator');
const errorModal = document.getElementById('error-modal');
const errorMessageElem = document.getElementById('error-message');
const closeErrorModalBtn = document.getElementById('close-error-modal');
const newSessionBtn = document.getElementById('new-session-btn');
const newSessionContainer = document.getElementById('new-session-container');
const reminderContainer = document.getElementById('reminder-container');
const enableRemindersBtn = document.getElementById('enable-reminders-btn');
const formModal = document.getElementById('form-modal');
const saveFormBtn = document.getElementById('save-form-btn');
const userNameElem = document.getElementById('user-name');
// NOVAS VARI√ÅVEIS PARA O TCLE
const tcleModal = document.getElementById('tcle-modal');
const tcleConsentCheckbox = document.getElementById('tcle-consent-checkbox');
const tcleParticiparBtn = document.getElementById('tcle-participar-btn');

// ==========================================================
// ESTRUTURA DE PERGUNTAS COM OP√á√ïES DE BOT√ÉO (ATUALIZADA)
// ==========================================================
const dailyQuestions = [
    // I. Avalia√ß√£o Geral e Sintomas Principais (Q1 a Q3)
    { 
        text: "1. Como voc√™ se sente no geral hoje em compara√ß√£o com ontem e com o in√≠cio do tratamento?",
        type: "select",
        options: ["Sinto-me muito melhor", "Sinto-me um pouco melhor", "Igual a ontem", "Sinto-me pior", "N√£o sei dizer"]
    },
    {
        text: "2. A febre diminuiu ou est√° mais controlada? Qual foi a temperatura m√°xima que voc√™ mediu nas √∫ltimas 24 horas?",
        type: "select",
        options: ["N√£o tive febre", "Diminuiu e est√° controlada (m√°x 37.5¬∞C)", "Persiste, mas com melhora (m√°x 38.5¬∞C)", "Persiste alta e intensa (acima de 38.5¬∞C)"],
        warning: (response) => response.includes("acima de 38.5¬∞C") ? "**Sinal de Alerta:** Febre alta persistente. Por favor, procure atendimento m√©dico IMEDIATO." : null
    },
    {
        text: "3. Voc√™ ainda tem calafrios e tremores intensos? Eles est√£o menos frequentes ou menos intensos do que antes?",
        type: "select",
        options: ["N√£o tenho mais", "Est√£o muito mais leves/raros", "Est√£o iguais a antes", "Est√£o mais intensos/frequentes"]
    },

    // II. Outros Sintomas Comuns e N√≠vel de Energia (Q4 a Q6)
    {
        text: "4. As dores de cabe√ßa e as dores no corpo (musculares ou nas articula√ß√µes) est√£o mais leves ou continuam fortes?",
        type: "select",
        options: ["N√£o sinto mais dores", "Dores muito mais leves", "Continuam fortes", "Est√£o piores"]
    },
    {
        text: "5. Voc√™ tem conseguido se alimentar e beber l√≠quidos normalmente? Houve v√¥mitos ou diarreia nas √∫ltimas horas?",
        type: "select",
        options: ["Sim, alimenta√ß√£o e hidrata√ß√£o normais", "Consigo comer e beber, mas com dificuldade", "Tive v√¥mitos ou diarreia isolados", "V√¥mitos ou diarreia persistentes e intensos"],
        warning: (response) => response.includes("persistentes e intensos") ? "**Sinal de Alerta:** V√¥mitos/Diarreia intensos. Risco de desidrata√ß√£o e m√° absor√ß√£o da medica√ß√£o. Procure atendimento m√©dico IMEDIATO." : null
    },
    {
        text: "6. Como est√° seu n√≠vel de energia e disposi√ß√£o? Voc√™ se sente muito cansado, com fraqueza extrema ou consegue realizar atividades simples com menos dificuldade?",
        type: "select",
        options: ["Sinto-me com energia normal/melhor", "Ainda sinto fraqueza, mas consigo me mover", "Cansa√ßo e fraqueza extremas, dificuldade para atividades simples"]
    },

    // III. Sinais de Alerta para Buscar Ajuda M√©dica Imediata (Mal√°ria Grave) (Q7 a Q12)
    {
        text: "7. Voc√™ notou alguma colora√ß√£o amarelada na pele ou nos olhos (icter√≠cia)?",
        type: "select",
        options: ["N√£o", "Sim"],
        warning: (response) => response === "Sim" ? "**SINAL DE ALERTA GRAVE:** Procure atendimento m√©dico IMEDIATO." : null
    },
    {
        text: "8. Sua respira√ß√£o est√° normal ou voc√™ tem sentido falta de ar, dificuldade para respirar ou respira√ß√£o muito r√°pida e superficial, mesmo em repouso?",
        type: "select",
        options: ["Respira√ß√£o normal", "Sinto leve dificuldade ao fazer esfor√ßo", "Sinto falta de ar em repouso ou dificuldade intensa para respirar"],
        warning: (response) => response.includes("dificuldade intensa") ? "**SINAL DE ALERTA GRAVE:** Procure atendimento m√©dico IMEDIATO." : null
    },
    {
        text: "9. Voc√™ sentiu tonturas intensas, desmaios, confus√£o mental (dificuldade de racioc√≠nio, desorienta√ß√£o), sonol√™ncia excessiva ou dificuldade para se manter acordado?",
        type: "select",
        options: ["N√£o", "Sim, senti tonturas/sonol√™ncia leves", "Sim, senti confus√£o mental, tontura intensa ou desmaios"],
        warning: (response) => response.includes("confus√£o mental") || response.includes("desmaios") ? "**SINAL DE ALERTA GRAV√çSSIMO:** Procure atendimento m√©dico IMEDIATO." : null
    },
    {
        text: "10. Voc√™ est√° urinando menos do que o normal, sua urina est√° muito escura ou notou incha√ßo nas pernas e tornozelos?",
        type: "select",
        options: ["Normal", "Sim, estou urinando menos e/ou urina escura"],
        warning: (response) => response.includes("Sim") ? "**SINAL DE ALERTA GRAVE:** Pode indicar problema renal. Procure atendimento m√©dico IMEDIATO." : null
    },
    {
        text: "11. H√° sangramentos incomuns (pelo nariz, gengivas, manchas roxas na pele, urina ou fezes com sangue)?",
        type: "select",
        options: ["N√£o", "Sim"],
        warning: (response) => response === "Sim" ? "**SINAL DE ALERTA GRAVE:** Procure atendimento m√©dico IMEDIATO." : null
    },
    {
        text: "12. Voc√™ sentiu dores intensas no abd√¥men, no peito ou nas costas, ou sensibilidade aumentada na barriga?",
        type: "select",
        options: ["N√£o", "Senti dor leve e passageira", "Senti dor intensa e persistente no abd√¥men, peito ou costas"],
        warning: (response) => response.includes("intensa e persistente") ? "**SINAL DE ALERTA GRAVE:** Procure atendimento m√©dico IMEDIATO." : null
    },

    // IV. Ades√£o ao Tratamento e Acompanhamento (Q13 e Q14)
    {
        text: "13. Voc√™ est√° tomando todos os medicamentos exatamente como o m√©dico prescreveu, nos hor√°rios certos e sem esquecer nenhuma dose?",
        type: "select",
        options: ["Sim, corretamente", "Esqueci doses ou errei o hor√°rio", "Parei de tomar a medica√ß√£o"]
    },
    {
        text: "14. A medica√ß√£o est√° causando algum efeito colateral intenso e insuport√°vel (al√©m do que foi avisado pelo m√©dico)?",
        type: "select",
        options: ["N√£o, os efeitos s√£o leves/suport√°veis", "Sim, os efeitos colaterais s√£o intensos e insuport√°veis"],
        warning: (response) => response.includes("insuport√°veis") ? "Importante: Entre em contato com a Unidade de Sa√∫de para avalia√ß√£o e poss√≠vel ajuste." : null
    },
    
    // V. BUSCA POR AJUDA E AUTOMEDICA√á√ÉO (NOVAS PERGUNTAS)
    {
        text: "15. Desde o seu √∫ltimo check-in (ou atendimento), voc√™ precisou buscar atendimento em alguma Unidade B√°sica de Sa√∫de (UBS), Unidade de Pronto Atendimento (UPA) ou Hospital?",
        type: "select",
        options: ["N√£o, n√£o procurei ajuda", "Sim, procurei e fui reavaliado(a)", "Estou a caminho da unidade agora"],
        warning: (response) => response.includes("a caminho") ? "Por favor, continue nos informando ap√≥s a reavalia√ß√£o m√©dica. Tenha um atendimento seguro." : null
    },
    {
        text: "16. Voc√™ tomou algum medicamento para febre, dor ou outros sintomas que N√ÉO FOI receitado especificamente para o tratamento da mal√°ria?",
        type: "select",
        options: ["N√£o, apenas a medica√ß√£o prescrita", "Sim, tomei (Ex: Paracetamol, Dipirona, vitaminas)", "Sim, tomei antibi√≥ticos ou outros rem√©dios fortes por conta pr√≥pria"],
        warning: (response) => response.includes("por conta pr√≥pria") ? "**Aten√ß√£o!** A automedica√ß√£o pode ser perigosa e interferir no tratamento da mal√°ria. Por favor, evite tomar rem√©dios n√£o prescritos." : null
    },

    // VI. CONTROLE DE CURA (DIN√ÇMICA)
    {
        text: "17. A data recomendada para seu pr√≥ximo exame de Gota Espessa de controle √©: [DATA CALCULADA]. Voc√™ pretende comparecer ao seu retorno/exame conforme indica√ß√£o m√©dica?",
        type: "select",
        options: ["Sim, irei na data indicada", "J√° realizei (e deu negativo)", "J√° realizei (e deu positivo)", "N√£o poderei comparecer"]
    }
];
// ==========================================================


// Vari√°vel para rastrear o estado da conversa e dados do usu√°rio
let conversationStep = 0;
let userResponses = {};
let isWaitingForSummary = false;
let userProfileData = null;

// VARI√ÅVEIS PARA O TEMPORIZADOR DE INATIVIDADE
let inactivityTimer;
const INACTIVITY_TIMEOUT = 3 * 60 * 1000; // 5 minutos em milissegundos
let isSessionActive = false; // Come√ßa como inativa at√© o login e in√≠cio do question√°rio

// Fun√ß√£o para mostrar o modal de erro
function showError(message) {
    errorMessageElem.innerHTML = message; // Usando innerHTML para permitir formata√ß√£o de texto (negrito)
    errorModal.classList.remove('hidden');
}

closeErrorModalBtn.onclick = () => {
    errorModal.classList.add('hidden');
};

// Fun√ß√£o para rolar para o final do chat
function scrollToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Fun√ß√µes de formato de data e hora
function formatTimestamp(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate();
    const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };
    const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
    const formattedDate = date.toLocaleDateString('pt-BR', dateOptions);
    const formattedTime = date.toLocaleTimeString('pt-BR', timeOptions);
    return `${formattedDate} ${formattedTime}`;
}

function getFormattedDate() {
    const today = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return today.toLocaleDateString('pt-BR', options);
}

/**
 * Calcula a pr√≥xima data de controle de Gota Espessa (Dia 3, 7, 14 ou 28)
 * com base na data do primeiro atendimento e na data atual.
 * @param {string} firstConsultationDateString - Data do primeiro atendimento (YYYY-MM-DD).
 * @returns {string} Texto indicando o pr√≥ximo controle necess√°rio ou "Completo" se j√° passou o D28.
 */
function calculateNextControlDate(firstConsultationDateString) {
    if (!firstConsultationDateString) return "Data n√£o fornecida. Por favor, procure sua UBS.";

    const initialDate = new Date(firstConsultationDateString + 'T00:00:00'); // Garante que √© meia-noite
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const controls = [3, 7, 14, 28]; // Dias para o controle
    
    // Adiciona 1 dia porque o controle D+N ocorre N dias AP√ìS o D0 (dia do atendimento)
    // O D1 √© o dia seguinte ao D0.
    const getControlDate = (day) => {
        const controlDate = new Date(initialDate);
        controlDate.setDate(initialDate.getDate() + day);
        return controlDate;
    };

    let nextControl = null;

    for (const day of controls) {
        const controlDate = getControlDate(day);
        
        // Verifica se a data de controle √© no futuro ou hoje (mas n√£o no passado)
        if (controlDate >= today) {
            nextControl = { day: day, date: controlDate };
            break; // Encontrou o pr√≥ximo controle
        }
    }

    if (nextControl) {
        const controlDate = nextControl.date;
        const formattedDate = controlDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        
        // Verifica se o controle √© hoje
        if (controlDate.getTime() === today.getTime()) {
            return `HOJE (Dia ${nextControl.day}, ${formattedDate})`;
        } else {
            return `Dia ${nextControl.day} (${formattedDate})`;
        }
    }

    // Se a data de controle D28 j√° passou
    const d28Date = getControlDate(28);
    if (d28Date < today) {
        return "Controle D28 j√° realizado. Continue o monitoramento, mas o controle laboratorial prim√°rio est√° completo.";
    }

    return "Erro no c√°lculo. Procure a unidade de sa√∫de para confirmar a data correta.";
}

// Fun√ß√£o para exibir mensagem no chat
function displayMessage(message, isUser, timestamp) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `my-2 p-2 rounded max-w-sm whitespace-pre-wrap ${isUser ? 'user-message self-end' : 'gemini-message self-start'}`;

    const textNode = document.createElement('p');
    textNode.textContent = message;
    messageDiv.appendChild(textNode);

    const timestampNode = document.createElement('span');
    timestampNode.className = `text-xs mt-1 block ${isUser ? 'text-gray-400' : 'text-gray-500'}`;
    
    const dateOptionsFallback = { year: 'numeric', month: '2-digit', day: '2-digit' };
    const timeOptionsFallback = { hour: '2-digit', minute: '2-digit', hour12: false };
    const now = new Date();
    const fallbackDisplay = `${now.toLocaleDateString('pt-BR', dateOptionsFallback)} ${now.toLocaleTimeString('pt-BR', timeOptionsFallback)}`;

    timestampNode.textContent = timestamp 
        ? formatTimestamp(timestamp) 
        : fallbackDisplay; 

    messageDiv.appendChild(timestampNode);

    chatContainer.appendChild(messageDiv);
    scrollToBottom();
}

// ==========================================================
// üö® FUN√á√ÉO ADAPTADA PARA EXIBIR PERGUNTA E BOT√ïES INLINE
// ==========================================================
async function displayQuestionWithButtons(question) {
    const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/chat_messages`);
    let questionText = question.text;
    
    // ‚ö†Ô∏è L√≥gica para a PERGUNTA DIN√ÇMICA (Q17)
    if (question.text.includes("[DATA CALCULADA]") && userProfileData && userProfileData.dataAtendimento) {
        const nextControlInfo = calculateNextControlDate(userProfileData.dataAtendimento);
        questionText = question.text.replace("[DATA CALCULADA]", nextControlInfo);
    }

    // 1. Adiciona a pergunta ao Firestore (e ao chat via onSnapshot)
    await addDoc(chatCollectionRef, { text: questionText, isUser: false, timestamp: serverTimestamp() });
    
    // 2. Desabilita o input enquanto espera a resposta de bot√£o/texto
    messageInput.disabled = true;
    sendBtn.disabled = true;

    // Se for uma pergunta de sele√ß√£o, adiciona os bot√µes no DOM
    if (question.type === 'select' && question.options) {
        // Esperamos um pequeno tempo para garantir que a mensagem foi renderizada.
        await new Promise(resolve => setTimeout(resolve, 50)); 
        
        const lastMessageDiv = chatContainer.lastElementChild;
        if (!lastMessageDiv || lastMessageDiv.classList.contains('user-message')) {
            console.error("N√£o foi poss√≠vel encontrar a √∫ltima mensagem do bot para anexar bot√µes.");
            messageInput.disabled = false;
            sendBtn.disabled = false;
            return;
        }

        const buttonsDiv = document.createElement('div');
        // Identificador exclusivo para remover os bot√µes ap√≥s a resposta
        buttonsDiv.classList.add('response-buttons', 'mt-2', 'p-2', 'bg-white', 'rounded-b-lg', 'shadow-md');
        
        question.options.forEach(optionText => {
            const button = document.createElement('button');
            button.className = 'w-full text-left bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-medium py-2 px-4 rounded-lg my-1 transition duration-150 ease-in-out shadow-sm text-sm';
            button.textContent = optionText;
            button.onclick = () => processButtonResponse(optionText);
            buttonsDiv.appendChild(button);
        });

        // Adiciona os bot√µes ao final da div da mensagem do Bot
        lastMessageDiv.appendChild(buttonsDiv);
        scrollToBottom();

    } else {
        // Se for tipo 'text', reabilita o input
        messageInput.disabled = false;
        sendBtn.disabled = false;
    }
}
// ==========================================================

// ==========================================================
// üö® FUN√á√ÉO PARA PROCESSAR RESPOSTAS DE BOT√ÉO (AGORA REMOVE O BOT√ÉO)
// ==========================================================
async function processButtonResponse(response) {
    if (!currentUser || isWaitingForSummary) return;

    // 1. Remove os bot√µes de resposta da tela
    const buttons = chatContainer.querySelectorAll('.response-buttons');
    buttons.forEach(btn => btn.remove());
    
    // 2. Reabilita o input e simula o envio de mensagem do usu√°rio
    messageInput.disabled = false;
    sendBtn.disabled = false;
    
    await sendMessage(response, true); 
}
// ==========================================================


// FUN√á√ïES DO TEMPORIZADOR
function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    if (currentUser && isSessionActive) {
        inactivityTimer = setTimeout(endSession, INACTIVITY_TIMEOUT);
    }
}

async function endSession() {
    if (!currentUser || !isSessionActive) return;

    isSessionActive = false;
    messageInput.disabled = true;
    sendBtn.disabled = true;

    // Remove bot√µes existentes ao encerrar
    chatContainer.querySelectorAll('.response-buttons').forEach(btn => btn.remove());

    const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/chat_messages`);
    const endMessage = "Sess√£o encerrada por inatividade. Caso queira responder novamente para fins de acompanhamento da evolu√ß√£o cl√≠nica, registro di√°rio ou esclarecer d√∫vidas acerca do tratamento da Mal√°ria, clique no bot√£o Iniciar Sess√£o! Alertamos que as respostas s√£o realizadas por meio de Intelig√™ncia Artificial e caso persista os sintomas procure ajuda m√©dica imediatamente!";

    await addDoc(chatCollectionRef, { text: endMessage, isUser: false, timestamp: serverTimestamp() });
    conversationStep = -1; 
}

// Fun√ß√£o para gerar uma resposta do chatbot usando a API Gemini
async function getGeminiResponse(prompt) {
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;
    const payload = { contents: [{ parts: [{ text: prompt }] }] };

    let retries = 0;
    const maxRetries = 3;
    let success = false;
    let responseData;

    while (!success && retries < maxRetries) {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            if (!response.ok) { throw new Error(`Erro HTTP! status: ${response.status}`); }
            responseData = await response.json();
            success = true;
        } catch (e) {
            console.error("Erro na chamada da API:", e);
            retries++;
            if (retries < maxRetries) {
                const delay = Math.pow(2, retries) * 1000;
                await new Promise(res => setTimeout(res, delay));
            } else { throw e; }
        }
    }
    if (!success) { throw new Error('Falha na conex√£o com a API ap√≥s v√°rias tentativas.'); }
    const candidate = responseData.candidates?.[0];
    const text = candidate?.content?.parts?.[0]?.text;
    return text || "N√£o foi poss√≠vel gerar uma resposta. Tente novamente.";
}

// Fun√ß√£o para gerar uma resposta de reconhecimento com a API Gemini
async function getGeminiAcknowledgement(userResponse, questionText) {
    const prompt = `Gere uma pequena e amig√°vel resposta de reconhecimento, com cerca de 10 palavras, para a seguinte resposta do usu√°rio: "${userResponse}" √† pergunta: "${questionText}".`;
    return await getGeminiResponse(prompt);
}

// ==========================================================
// FUN√á√ÉO SENDMESSAGE ADAPTADA COM MELHOR TRATAMENTO DE ERROS
// ==========================================================
async function sendMessage(manualMessage = null, isButtonResponse = false) {
    if (!currentUser) {
        showError("Voc√™ precisa estar logado para enviar mensagens.");
        return;
    }

    const message = manualMessage || messageInput.value.trim();
    if (message === '' || isWaitingForSummary) return;

    // L√≥gica para reiniciar o question√°rio ap√≥s inatividade
    if (conversationStep === -1) {
        // Limpa bot√µes existentes
        chatContainer.querySelectorAll('.response-buttons').forEach(btn => btn.remove());
        
        messageInput.value = '';
        messageInput.disabled = true;
        sendBtn.disabled = true;
        loadingIndicator.classList.remove('hidden');

        const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/chat_messages`);
        await addDoc(chatCollectionRef, { text: message, isUser: true, timestamp: serverTimestamp() });
        
        await startNewSession(); 
        loadingIndicator.classList.add('hidden');
        resetInactivityTimer();
        return; 
    }

    resetInactivityTimer(); 

    if (!isButtonResponse) {
        messageInput.value = '';
    }
    
    loadingIndicator.classList.remove('hidden');

    // Vari√°vel para rastrear o √≠ndice da pergunta antes de avan√ßar o passo
    let questionIndexBeforeAdvance = -1;

    try {
        const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/chat_messages`);
        
        // 1. Salva a mensagem do usu√°rio
        await addDoc(chatCollectionRef, { text: message, isUser: true, timestamp: serverTimestamp() });

        const currentQuestionIndex = conversationStep;
        questionIndexBeforeAdvance = currentQuestionIndex; // Captura o √≠ndice antes de qualquer tentativa de avan√ßo
        
        if (currentQuestionIndex < dailyQuestions.length) {
            const currentQuestion = dailyQuestions[currentQuestionIndex];

            // 2. Salva a resposta do usu√°rio
            userResponses[currentQuestionIndex] = message;

            // 3. Verifica e envia o Alerta
            if (currentQuestion.warning) {
                const warningMessage = currentQuestion.warning(message);
                if (warningMessage) {
                    await addDoc(chatCollectionRef, { text: warningMessage, isUser: false, timestamp: serverTimestamp() });
                }
            }
            
            // 4. Mensagem de reconhecimento (Chamada de API)
            // Se for a pergunta din√¢mica 17, pega o texto real exibido no chat
            let questionTextForAck = currentQuestion.text;
             if (currentQuestionIndex === dailyQuestions.length - 1 && questionTextForAck.includes("[DATA CALCULADA]")) {
                questionTextForAck = dailyQuestions[currentQuestionIndex].text.replace("[DATA CALCULADA]", calculateNextControlDate(userProfileData.dataAtendimento));
            }

            const botResponseText = await getGeminiAcknowledgement(message, questionTextForAck);
            await addDoc(chatCollectionRef, { text: botResponseText, isUser: false, timestamp: serverTimestamp() });

            // 5. Avan√ßa o passo (SOMENTE AP√ìS O SUCESSO DO REGISTRO E ACK)
            conversationStep++;
            const nextQuestion = dailyQuestions[conversationStep];

            if (nextQuestion) {
                // 6. Exibe a pr√≥xima pergunta
                await displayQuestionWithButtons(nextQuestion);
                
            } else {
                // Fim do question√°rio
                await generateSummary(currentUser);
            }

        } else {
            // Se o question√°rio j√° foi conclu√≠do (L√≥gica de Mal√°ria e Bate-papo)
            const malariaKeywords = ["mal√°ria", "malaria", "sintomas", "tratamento", "diagn√≥stico", "preven√ß√£o", "d√∫vida", "exame"];
            const isMalariaQuestion = malariaKeywords.some(keyword => message.toLowerCase().includes(keyword));

            if (isMalariaQuestion) {
                const prompt = `Com base nas informa√ß√µes do Minist√©rio da Sa√∫de sobre mal√°ria em https://www.gov.br/saude/pt-br/assuntos/saude-de-a-a-z/m/malaria ou outra autoridade internacional refer√™ncia no assunto, gere uma resposta detalhada, resumida e amig√°vel sobre a pergunta: "${message}".`;
                const botResponse = await getGeminiResponse(prompt);
                await addDoc(chatCollectionRef, { text: botResponse, isUser: false, timestamp: serverTimestamp() });
            } else {
                const prompt = `Responda de forma amig√°vel e breve √† seguinte mensagem do usu√°rio, sem iniciar um novo question√°rio: "${message}".`;
                const botResponse = await getGeminiResponse(prompt);
                await addDoc(chatCollectionRef, { text: botResponse, isUser: false, timestamp: serverTimestamp() });
            }
        }

    } catch (error) {
        console.error("Erro ao enviar mensagem ou obter resposta:", error);
        
        let customErrorMsg = "N√£o foi poss√≠vel enviar a mensagem ou obter a resposta do chatbot. Tente novamente mais tarde.";

        if (questionIndexBeforeAdvance !== -1 && questionIndexBeforeAdvance < dailyQuestions.length) {
            // Se a falha ocorreu durante o processamento de uma pergunta espec√≠fica (antes do avan√ßo do 'conversationStep')
            const failedQuestionNum = questionIndexBeforeAdvance + 1;
            customErrorMsg = `Ocorreu um erro ao registrar sua resposta para a **Pergunta ${failedQuestionNum}**. Por favor, tente enviar a mensagem novamente. Sua sess√£o **n√£o avan√ßou** e voc√™ pode **retentar** a resposta.`;
        }

        showError(customErrorMsg);
        // Reabilita o input e o bot√£o de envio
        messageInput.disabled = false;
        sendBtn.disabled = false;
    } finally {
        loadingIndicator.classList.add('hidden');
    }
}
// ==========================================================

async function generateSummary(user) {
    isWaitingForSummary = true;
    messageInput.disabled = true;
    sendBtn.disabled = true;
    clearTimeout(inactivityTimer); 

    const formattedDate = getFormattedDate();

    // Remove bot√µes de qualquer pergunta anterior que possa ter ficado
    chatContainer.querySelectorAll('.response-buttons').forEach(btn => btn.remove());


    const summaryPrompt = `Gere um relat√≥rio detalhado com a seguinte estrutura e informa√ß√µes:
**Data:** ${formattedDate}
**Fonte das Informa√ß√µes:** Respostas a question√°rio de sa√∫de.
---
### **1. An√°lise das Respostas Individuais:**
${Object.keys(userResponses).map(key => {
    let questionText = dailyQuestions[key].text;
    const responseText = userResponses[key];

    // Trata a pergunta din√¢mica Q17
    if (parseInt(key) === dailyQuestions.length - 1 && questionText.includes("[DATA CALCULADA]")) {
        questionText = questionText.replace("[DATA CALCULADA]", calculateNextControlDate(userProfileData.dataAtendimento));
    }

    return `* **Pergunta ${parseInt(key) + 1}: ${questionText} Resposta: ${responseText}**\n ¬† ¬† * **Avalia√ß√£o:** (Gere uma avalia√ß√£o curta para esta resposta)`
}).join('\n')}
---

### **2. Sintomas Relatados e Avalia√ß√£o da Gravidade:**
(Gere um par√°grafo que liste os sintomas relatados ou a aus√™ncia deles e avalie a gravidade. **DESTAQUE se a pergunta 7 a 12 (Sinais de Alerta) foi respondida com uma op√ß√£o que indica gravidade.**)
---
### **3. Conduta do Paciente:**
(Gere um par√°grafo que descreva as a√ß√µes do paciente com base nas respostas, **incluindo se houve automedica√ß√£o e se buscou ajuda em UBS/UPA**.)
---
### **4. Conclus√£o e Recomenda√ß√µes:**
(Gere uma conclus√£o forte. Se os sintomas (como febre alta, v√¥mito, diarreia, calafrios) forem persistentes ou indicativos de gravidade, a conclus√£o deve ser uma forte recomenda√ß√£o para o paciente procurar a unidade de sa√∫de mais pr√≥xima, com urg√™ncia. Se os sintomas n√£o forem graves ou se o paciente estiver se sentindo bem, a conclus√£o deve indicar que n√£o √© necess√°rio procurar uma unidade de sa√∫de, mas sim continuar se hidratando e fazendo uso correto da medica√ß√£o, se aplic√°vel e indique se houve evolu√ß√£o clinica entre o monitoramento anterior e o atual, caso exista.)
---
### **5. Informe sobre o tratamento da mal√°ria:**
(Gere um par√°grafo que descreva o que √© a mal√°ria, seu tratamento e caso necessite falar a respeito do tratamento, do diagin√≥stico e do estado cl√≠nico apresentado, pode ser feito por aqui, basta formular a sua pergunta!)

`;

    const botResponse = await getGeminiResponse(summaryPrompt);

    const checkinRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/checkin_status/daily_status`);
    await setDoc(checkinRef, { lastCheckin: serverTimestamp(), summary: botResponse });

    const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/chat_messages`);
    
    await addDoc(chatCollectionRef, { text: "‚ú® Relat√≥rio Detalhado:\n" + botResponse, isUser: false, timestamp: serverTimestamp() });
    
    const finalQuestion = "Agradecemos sua participa√ß√£o! Espero que seu estado cl√≠nico evolua rapidamente e sua sa√∫de seja restabelecida. Estamos trabalhando fortemente para erradicar a Mal√°ria em Porto Velho e sua participa√ß√£o √© de fundamental import√¢ncia, conte conosco! Estaremos sempre √† disposi√ß√£o. Fique a vontade para tirar d√∫vidas com a nossa Intelig√™ncia Artificial.";
    await addDoc(chatCollectionRef, { text: finalQuestion, isUser: false, timestamp: serverTimestamp() });

    isWaitingForSummary = false;
    messageInput.disabled = false;
    sendBtn.disabled = false;
    newSessionContainer.classList.remove('hidden');
    conversationStep = dailyQuestions.length;
    resetInactivityTimer(); 
}

async function startNewSession() {
    if (!currentUser) {
        showError("Voc√™ precisa estar logado para iniciar uma nova sess√£o.");
        return;
    }
    loadingIndicator.classList.remove('hidden');
    try {
        const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/chat_messages`);
        const docsToDelete = await getDocs(chatCollectionRef);
        const deletePromises = docsToDelete.docs.map(docToDelete => deleteDoc(doc(db, chatCollectionRef.path, docToDelete.id)));
        await Promise.all(deletePromises);
        await startInitialConversation(currentUser);
        newSessionContainer.classList.add('hidden');
    } catch (error) {
        console.error("Erro ao iniciar nova sess√£o:", error);
        showError("N√£o foi poss√≠vel iniciar uma nova sess√£o. Tente novamente mais tarde.");
    } finally {
        loadingIndicator.classList.add('hidden');
    }
}

async function startInitialConversation(user) {
    const userProfileRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}`);
    const userProfileSnap = await getDoc(userProfileRef);
    const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/chat_messages`);

    conversationStep = 0;
    userResponses = {};
    isSessionActive = true; 
    resetInactivityTimer(); 

    // Remove bot√µes remanescentes de qualquer sess√£o anterior
    chatContainer.querySelectorAll('.response-buttons').forEach(btn => btn.remove());


    if (!userProfileSnap.exists()) {
        formModal.classList.remove('hidden');
        messageInput.disabled = true;
        sendBtn.disabled = true;
        isSessionActive = false;
    } else {
        userProfileData = userProfileSnap.data();

        if (!userProfileData.consentido) {
            tcleModal.classList.remove('hidden');
            messageInput.disabled = true;
            sendBtn.disabled = true;
            isSessionActive = false;
            return;
        }

        const checkinRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/checkin_status/daily_status`);
        const checkinSnap = await getDoc(checkinRef);

        const firstQuestion = dailyQuestions[0];
        
        if (checkinSnap.exists()) {
            const lastSummary = checkinSnap.data().summary;
            const summaryMessage = `Ol√°, ${user.displayName}! üëã Que bom te ver de volta. Aqui est√° um resumo da sua √∫ltima consulta: \n\n${lastSummary}`;
            await addDoc(chatCollectionRef, { text: summaryMessage, isUser: false, timestamp: serverTimestamp() });
            
            await displayQuestionWithButtons(firstQuestion);

        } else {
            const welcomeMessage = `Ol√°, ${user.displayName}! üëã Que bom que voc√™ chegou at√© aqui. Vamos come√ßar o seu primeiro check-in di√°rio.`;
            await addDoc(chatCollectionRef, { text: welcomeMessage, isUser: false, timestamp: serverTimestamp() });
            
            await displayQuestionWithButtons(firstQuestion);
        }
    }
}

async function startFreshSession(user) {
    loadingIndicator.classList.remove('hidden');
    try {
        // 1. Limpa o estado da aplica√ß√£o
        chatContainer.innerHTML = ''; 
        conversationStep = 0;
        userResponses = {};
        isSessionActive = false; 

        // 2. Limpa o hist√≥rico de chat no Firestore
        const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/chat_messages`);
        const docsToDelete = await getDocs(chatCollectionRef);
        const deletePromises = docsToDelete.docs.map(docToDelete => deleteDoc(doc(db, chatCollectionRef.path, docToDelete.id)));
        await Promise.all(deletePromises);
        
        // 3. Inicia a conversa
        await startInitialConversation(user); 
    } catch (error) {
        console.error("Erro ao iniciar sess√£o limpa:", error);
        showError("N√£o foi poss√≠vel reiniciar a sess√£o. Tente novamente mais tarde.");
    } finally {
        loadingIndicator.classList.add('hidden');
    }
}

async function handleFormSubmission() {
    if (!currentUser) {
        showError("Erro: Usu√°rio n√£o autenticado.");
        return;
    }

    const requiredFields = ['rg', 'cpf', 'endereco', 'cidade', 'estado', 'tipoMalaria', 'inicioSintomas', 'dataAtendimento', 'unidadeAtendimento'];
    
    // Verifica se todos os campos est√£o preenchidos, incluindo o select
    const isFormValid = requiredFields.every(id => {
        const element = document.getElementById(id);
        if (element.tagName === 'SELECT') {
            return element.value !== ""; // Verifica se alguma op√ß√£o foi selecionada
        }
        return element.value.trim() !== ''; // Verifica campos de texto/data
    });


    if (!isFormValid) {
        showError("Por favor, preencha todos os campos do formul√°rio para continuar.");
        return;
    }

    const formData = {
        rg: document.getElementById('rg').value,
        cpf: document.getElementById('cpf').value,
        endereco: document.getElementById('endereco').value,
        cidade: document.getElementById('cidade').value,
        estado: document.getElementById('estado').value,
        tipoMalaria: document.getElementById('tipoMalaria').value,
        inicioSintomas: document.getElementById('inicioSintomas').value,
        dataAtendimento: document.getElementById('dataAtendimento').value,
        unidadeAtendimento: document.getElementById('unidadeAtendimento').value,
        medicacaoDistribuida: document.getElementById('medicacaoDistribuida').checked,
        teveFebre: document.getElementById('teveFebre').checked,
        hipertenso: document.getElementById('hipertenso').checked,
        diabetes: document.getElementById('diabetes').checked,
        consentido: false 
    };

    try {
        const userProfileRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}`);
        await setDoc(userProfileRef, {
            uid: currentUser.uid, email: currentUser.email, displayName: currentUser.displayName,
            createdAt: serverTimestamp(), ...formData
        });
        formModal.classList.add('hidden');
        tcleModal.classList.remove('hidden');

        const userProfileSnap = await getDoc(userProfileRef);
        userProfileData = userProfileSnap.data();

    } catch (error) {
        console.error("Erro ao salvar dados do formul√°rio:", error);
        showError("N√£o foi poss√≠vel salvar seus dados. Tente novamente.");
    }
}

tcleConsentCheckbox.addEventListener('change', () => {
    if (tcleConsentCheckbox.checked) {
        tcleParticiparBtn.disabled = false;
        tcleParticiparBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
        tcleParticiparBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'focus:ring-indigo-500');
    } else {
        tcleParticiparBtn.disabled = true;
        tcleParticiparBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
        tcleParticiparBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'focus:ring-indigo-500');
    }
});

tcleParticiparBtn.addEventListener('click', async () => {
    if (!tcleConsentCheckbox.checked) {
        showError("Voc√™ deve concordar com o Termo de Consentimento para participar.");
        return;
    }

    try {
        const userProfileRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${currentUser.uid}`);
        await setDoc(userProfileRef, { consentido: true, consentimentoTimestamp: serverTimestamp() }, { merge: true });

        tcleModal.classList.add('hidden');
        await startInitialConversation(currentUser);

    } catch (error) {
        console.error("Erro ao registrar consentimento:", error);
        showError("N√£o foi poss√≠vel registrar seu consentimento. Tente novamente.");
    }
});

googleSigninBtn.onclick = async () => {
    const provider = new GoogleAuthProvider();
    try {
        await signInWithPopup(auth, provider);
    } catch (error) {
        console.error("Erro no login com Google:", error);
        showError("Falha ao entrar com Google. Tente novamente.");
    }
};

onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = user;
        // Atualiza o nome do usu√°rio no cabe√ßalho
        userNameElem.textContent = `Ol√°, ${user.displayName || user.email}!`; 

        loginScreen.classList.add('opacity-0', 'pointer-events-none');
        setTimeout(() => {
            loginScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');
            chatScreen.classList.add('opacity-100');
            
            // For√ßa o rein√≠cio da sess√£o (apaga o hist√≥rico e inicia a 1¬™ pergunta/modal)
            startFreshSession(user); 
            
            listenForMessages(user); 
        }, 500);
    } else {
        currentUser = null;
        // Ao deslogar, limpa quaisquer bot√µes que possam estar na tela
        chatContainer.querySelectorAll('.response-buttons').forEach(btn => btn.remove());
        
        chatScreen.classList.remove('opacity-100');
        chatScreen.classList.add('opacity-0');
        loginScreen.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
        messageInput.disabled = true;
        sendBtn.disabled = true;
        isSessionActive = false;
        clearTimeout(inactivityTimer);
    }
});

function listenForMessages(user) {
    if (!user) return;
    const chatCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/chat_messages`);
    const q = query(chatCollectionRef, orderBy("timestamp", "asc"));

    onSnapshot(q, (snapshot) => {
        resetInactivityTimer();
        
        snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
                const data = change.doc.data();
                displayMessage(data.text, data.isUser, data.timestamp);
            }
        });
    });
}

// Event listener para o bot√£o Salvar do formul√°rio
saveFormBtn.addEventListener('click', handleFormSubmission);

// Event listener para o bot√£o de Envio (Send)
sendBtn.addEventListener('click', () => sendMessage());

// Event listener para o Enter no input
messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
    }
});

// Event listener para o bot√£o Nova Sess√£o
newSessionBtn.addEventListener('click', startNewSession);
</script>
</body>
</html>
